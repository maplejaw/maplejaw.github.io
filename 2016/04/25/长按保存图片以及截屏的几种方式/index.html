<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Android ImageView长按保存图片及截屏相关知识 | maplejaw的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在日常开发中，可能会需要做长按保存图片这个功能，又或者需要做个截屏分享功能。最近正好在研究这些东西，写篇博客整理一下。

view长按保存图片的几种方式如果是网络图片，我们可以直接选择将图片下载下来后保存，这种方式，简单暴力，可以直接获得原图，本质其实就是下载文件。代码如下：
1234567891011121314151617181920212223242526272829303132333">
<meta property="og:type" content="article">
<meta property="og:title" content="Android ImageView长按保存图片及截屏相关知识">
<meta property="og:url" content="http://www.maplejaw.com/2016/04/25/长按保存图片以及截屏的几种方式/index.html">
<meta property="og:site_name" content="maplejaw的技术博客">
<meta property="og:description" content="在日常开发中，可能会需要做长按保存图片这个功能，又或者需要做个截屏分享功能。最近正好在研究这些东西，写篇博客整理一下。

view长按保存图片的几种方式如果是网络图片，我们可以直接选择将图片下载下来后保存，这种方式，简单暴力，可以直接获得原图，本质其实就是下载文件。代码如下：
1234567891011121314151617181920212223242526272829303132333">
<meta property="og:updated_time" content="2016-05-07T03:00:57.053Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android ImageView长按保存图片及截屏相关知识">
<meta name="twitter:description" content="在日常开发中，可能会需要做长按保存图片这个功能，又或者需要做个截屏分享功能。最近正好在研究这些东西，写篇博客整理一下。

view长按保存图片的几种方式如果是网络图片，我们可以直接选择将图片下载下来后保存，这种方式，简单暴力，可以直接获得原图，本质其实就是下载文件。代码如下：
1234567891011121314151617181920212223242526272829303132333">
  
    <link rel="alternative" href="/atom.xml" title="maplejaw的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">maplejaw</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不忘初心，方得始终</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/RxJava/" style="font-size: 12px;">RxJava</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/开源库/" style="font-size: 10px;">开源库</a> <a href="/tags/插件化探索/" style="font-size: 16px;">插件化探索</a> <a href="/tags/源码解读/" style="font-size: 18px;">源码解读</a> <a href="/tags/知识整理/" style="font-size: 12px;">知识整理</a> <a href="/tags/自定义View/" style="font-size: 10px;">自定义View</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">maplejaw</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">maplejaw</h1>
			</hgroup>
			
			<p class="header-subtitle">不忘初心，方得始终</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-长按保存图片以及截屏的几种方式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/25/长按保存图片以及截屏的几种方式/" class="article-date">
  	<time datetime="2016-04-25T11:15:00.000Z" itemprop="datePublished">2016-04-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android ImageView长按保存图片及截屏相关知识
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/知识整理/">知识整理</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>  在日常开发中，可能会需要做长按保存图片这个功能，又或者需要做个截屏分享功能。最近正好在研究这些东西，写篇博客整理一下。</p>
</blockquote>
<h2 id="view长按保存图片的几种方式"><a href="#view长按保存图片的几种方式" class="headerlink" title="view长按保存图片的几种方式"></a>view长按保存图片的几种方式</h2><p>如果是网络图片，我们可以直接选择将图片下载下来后保存，这种方式，简单暴力，可以直接获得原图，本质其实就是下载文件。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span>  <span class="title">downloadBitmap</span><span class="params">(String urlString, File fileDir)</span> </span>&#123;</span><br><span class="line">    URL url = <span class="keyword">null</span>;</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    HttpURLConnection conn=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isSuccess=<span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        url = <span class="keyword">new</span> URL(urlString);</span><br><span class="line">        <span class="comment">//开启连接</span></span><br><span class="line">       conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">        <span class="comment">//设置超时的时间，5000毫秒即5秒</span></span><br><span class="line">        conn.setConnectTimeout(<span class="number">5000</span>);</span><br><span class="line">        <span class="comment">//设置获取图片的方式为GET</span></span><br><span class="line">        conn.setRequestMethod(<span class="string">"GET"</span>);</span><br><span class="line">        conn.connect();</span><br><span class="line">        <span class="comment">//响应码为200，则访问成功</span></span><br><span class="line">        <span class="keyword">if</span> (conn.getResponseCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">//获取连接的输入流，这个输入流就是图片的输入流</span></span><br><span class="line">            is = conn.getInputStream();</span><br><span class="line">            <span class="keyword">if</span> (!fileDir.exists()) &#123;</span><br><span class="line">                fileDir.mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">            String fileName = urlString.substring(urlString.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>); <span class="comment">//根据链接获取文件名</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(fileDir, fileName);</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">//将输入流写入到我们定义好的文件中</span></span><br><span class="line">            <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将缓冲刷入文件</span></span><br><span class="line">            fos.flush();</span><br><span class="line">            isSuccess=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(fos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(is!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(conn!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                conn.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> isSuccess;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>上面的方法用于网络图片，好处是可以直接获得原图，缺点也显而易见，必须依赖于网络，并且可能会耗费用户的流量。那么问题来了，有没有其他办法可以直接保存ImageView里面的图片呢？幸运的是，的确可以做到，而且不止一种方式，下面我将逐一介绍。在介绍前，我们先来认识一下view里面的几个API：</p>
<ul>
<li><p>setDrawingCacheEnabled</p>
<blockquote>
<p>Enables or disables the drawing cache. When the drawing    cache is enabled, the next call to {@link #getDrawingCache()} or {@link #buildDrawingCache()} will draw the view in a bitmap. Calling {@link #draw(android.graphics.Canvas)} will not draw from the cache when the cache is enabled. To benefit from the cache, you must request the drawing cache by calling {@link #getDrawingCache()} and draw it on screen if the returned bitmap is not null.</p>
<p>由API可知,setDrawingCacheEnabled为true后，使用getDrawingCache会将该view绘制成bitmap并返回，setDrawingCacheEnabled为false后，会清空缓存。</p>
</blockquote>
</li>
<li><p>getDrawingCache</p>
<blockquote>
<p>Returns the bitmap in which this view drawing is cached. The returned bitmap is null when caching is disabled. If caching is enabled and the cache is not ready, this method will create it. Calling {@link #draw(android.graphics.Canvas)} will not draw from the cache when the cache is enabled. To benefit from the cache, you must request the drawing cache by calling this method and draw it on screen if the returned bitmap is not null.</p>
<p>由API可知,只要开启绘画缓存之后，如果缓存还没有准备好，就先创建缓存（将view绘制到bitmap中保存起来），创建缓存使用<code>buildDrawingCache</code>，可以手动调用，或者直接 <code>getDrawingCache</code> 则系统会自动创建缓存，并返回。</p>
</blockquote>
</li>
<li><p>buildDrawingCache</p>
<blockquote>
<p>如果缓存无效，则开始构建缓存（将view绘制成bitmap）</p>
</blockquote>
</li>
<li><p>destroyDrawingCache</p>
<blockquote>
<p>清空缓存，释放缓存的资源占用</p>
</blockquote>
</li>
</ul>
<p>在了解上面API，思路就已经很清晰了。以下是我整理的保存图片的几种方式。</p>
<ol>
<li><p>开启缓存保存图片，适用于所有view。但是这种方式保存的图片有个致命的缺点，所见即所得，比如ImageView的缩放类型为<code>ScaleType.CENTER_CROP</code>，此时保存的也是缩放过后的图片，这种效果可能有时无法满足我们的实际需求。但也不是一无是处，在后面的截屏介绍中，这种方法非常强大。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">saveBitmap</span><span class="params">(View view, String filePath)</span></span>&#123;</span><br><span class="line">    view.setDrawingCacheEnabled(<span class="keyword">true</span>);<span class="comment">//开启绘制缓存</span></span><br><span class="line">    Bitmap imageBitmap = view.getDrawingCache();</span><br><span class="line">    FileOutputStream outStream = <span class="keyword">null</span>;</span><br><span class="line">    File file=<span class="keyword">new</span> File(filePath);</span><br><span class="line">    <span class="keyword">if</span>(file.isDirectory())&#123;<span class="comment">//如果是目录不允许保存</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        imageBitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, outStream);</span><br><span class="line">        outStream.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(outStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            outStream.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        imageBitmap.recycle();</span><br><span class="line">        view.setDrawingCacheEnabled(<span class="keyword">false</span>);<span class="comment">//关闭绘制缓存</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的方式无法保存一张完整的图片，所以可能无法满足实际工作需求，这时就需要用到下面这种方法，这种方法可以获取整个图片，但是只适用于ImageView。其他view只能使用getBackground来获得Drawable对象，不满足实际需求，而且Background也不一定是BitmapDrawable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">saveBitmap</span><span class="params">(ImageView view, String filePath)</span> </span>&#123;</span><br><span class="line">       Drawable drawable = view.getDrawable();</span><br><span class="line">       <span class="keyword">if</span> (drawable == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       FileOutputStream outStream = <span class="keyword">null</span>;</span><br><span class="line">       File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">       <span class="keyword">if</span> (file.isDirectory()) &#123;<span class="comment">//如果是目录不允许保存</span></span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           outStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">           Bitmap bitmap = ((BitmapDrawable) drawable).getBitmap();</span><br><span class="line">           bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, outStream);</span><br><span class="line">           outStream.flush();</span><br><span class="line">           bitmap.recycle();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (outStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   outStream.close();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这种方式适用于所有的view，可以将view里的全部内容绘制成bitmap并保存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">saveBitmap</span><span class="params">(View view, String filePath)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建对应大小的bitmap</span></span><br><span class="line">    Bitmap  bitmap = Bitmap.createBitmap(view.getWidth(), view.getHeight(),</span><br><span class="line">            Bitmap.Config.RGB_565);</span><br><span class="line">    Canvas canvas = <span class="keyword">new</span> Canvas(bitmap);</span><br><span class="line">    view.draw(canvas);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//存储</span></span><br><span class="line">    FileOutputStream outStream = <span class="keyword">null</span>;</span><br><span class="line">    File file=<span class="keyword">new</span> File(filePath);</span><br><span class="line">    <span class="keyword">if</span>(file.isDirectory())&#123;<span class="comment">//如果是目录不允许保存</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, outStream);</span><br><span class="line">        outStream.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bitmap.recycle();</span><br><span class="line">            <span class="keyword">if</span>(outStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                outStream.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>关于长按保存图片功能已经介绍完了，下面来看看常见的截屏保存图片的方式。</p>
<h2 id="常见的截屏保存图片分享方式"><a href="#常见的截屏保存图片分享方式" class="headerlink" title="常见的截屏保存图片分享方式"></a>常见的截屏保存图片分享方式</h2><ul>
<li><p>获取当前屏幕截图，包含状态栏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotWithStatusBar</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">	View view = activity.getWindow().getDecorView();</span><br><span class="line">	view.setDrawingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">	view.buildDrawingCache();</span><br><span class="line">	Bitmap bitmap= view.getDrawingCache();</span><br><span class="line">	<span class="keyword">int</span> width = getScreenWidth(activity);<span class="comment">//获取屏幕的宽</span></span><br><span class="line">	<span class="keyword">int</span> height = getScreenHeight(activity);<span class="comment">//获取屏幕的高</span></span><br><span class="line">	Bitmap bm = <span class="keyword">null</span>;</span><br><span class="line">	bm = Bitmap.createBitmap(bitmap, <span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">	view.destroyDrawingCache();</span><br><span class="line">	<span class="keyword">return</span> bm;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取当前屏幕截图，不包含状态栏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotWithoutStatusBar</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">	View view = activity.getWindow().getDecorView();</span><br><span class="line">	view.setDrawingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">	view.buildDrawingCache();</span><br><span class="line">	Bitmap bitmap= view.getDrawingCache();</span><br><span class="line">	Rect frame = <span class="keyword">new</span> Rect();</span><br><span class="line">	activity.getWindow().getDecorView().getWindowVisibleDisplayFrame(frame);</span><br><span class="line">	<span class="keyword">int</span> statusBarHeight = frame.top;<span class="comment">//获取状态栏的高</span></span><br><span class="line">	<span class="keyword">int</span> width = getScreenWidth(activity);<span class="comment">//获取屏幕的宽</span></span><br><span class="line">	<span class="keyword">int</span> height = getScreenHeight(activity);<span class="comment">//获取屏幕的高</span></span><br><span class="line">	Bitmap bm = Bitmap.createBitmap(bitmap, <span class="number">0</span>, statusBarHeight, width, height - statusBarHeight);</span><br><span class="line">	view.destroyDrawingCache();</span><br><span class="line">	<span class="keyword">return</span> bm;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取当前屏幕截图，不包含状态栏以及标题栏（ActionBar）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotWithoutStatusBarAndTitle</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    View view = activity.getWindow().getDecorView();</span><br><span class="line">    view.setDrawingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">    view.buildDrawingCache();</span><br><span class="line">    Bitmap bitmap= view.getDrawingCache();</span><br><span class="line">    Rect frame = <span class="keyword">new</span> Rect();</span><br><span class="line">    activity.getWindow().getDecorView().getWindowVisibleDisplayFrame(frame);</span><br><span class="line">    <span class="keyword">int</span> statusBarHeight = frame.top;<span class="comment">//获取状态栏的高</span></span><br><span class="line">    <span class="keyword">int</span> titleBarHeight = activity.getWindow().findViewById(Window.ID_ANDROID_CONTENT).getTop();<span class="comment">//获取标题栏的高</span></span><br><span class="line">    <span class="keyword">int</span> width = getScreenWidth(activity);<span class="comment">//获取屏幕的宽</span></span><br><span class="line">    <span class="keyword">int</span> height = getScreenHeight(activity);<span class="comment">//获取屏幕的高</span></span><br><span class="line">    <span class="keyword">int</span> totalBarHeight=titleBarHeight+statusBarHeight;</span><br><span class="line">    Bitmap bm= Bitmap.createBitmap(bitmap, <span class="number">0</span>, totalBarHeight , width, height - totalBarHeight);</span><br><span class="line">    view.destroyDrawingCache();</span><br><span class="line">    <span class="keyword">return</span> bm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>截取Scrollview等ViewGroup里面的内容，常用于生成长微博，效果可参照<strong>简书</strong>的<strong>生成图片分享</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotForViewGroup</span><span class="params">(ViewGroup view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> totalHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 获取ViewGroup实际高度</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; view.getChildCount(); i++) &#123;</span><br><span class="line">        totalHeight += view.getChildAt(i).getHeight();</span><br><span class="line">        <span class="comment">//view.getChildAt(i).setBackgroundColor(0xffffffff);//这里可以设置背景颜色，以免背景透明看不出效果</span></span><br><span class="line">    &#125;</span><br><span class="line">    Bitmap bitmap= Bitmap.createBitmap(view.getWidth(), totalHeight,</span><br><span class="line">            Bitmap.Config.RGB_565);</span><br><span class="line">    Canvas canvas = <span class="keyword">new</span> Canvas(bitmap);</span><br><span class="line">    view.draw(canvas);</span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>截取WebView里面的全面内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Android 5.0以上 在Activity的setContentView之前要进行如下处理</span><br><span class="line"> * if(Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line"> *    WebView.enableSlowWholeDocumentDraw();</span><br><span class="line"> * &#125;</span><br><span class="line"> * <span class="doctag">@param</span> view</span><br><span class="line"> * <span class="doctag">@return</span></span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotForWebView</span><span class="params">(WebView view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> scale = view.getScale(); <span class="comment">//获取webview缩放率</span></span><br><span class="line">    <span class="keyword">int</span> webViewHeight = (<span class="keyword">int</span>) (view.getContentHeight() * scale);<span class="comment">//得到缩放后webview内容的高度</span></span><br><span class="line">    Bitmap bitmap = Bitmap.createBitmap(view.getWidth(),webViewHeight,Bitmap.Config.ARGB_8888);</span><br><span class="line">    Canvas canvas = <span class="keyword">new</span> Canvas(bitmap);</span><br><span class="line">    view.draw(canvas);</span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自由截屏，即手指滑动区域截屏</p>
</li>
</ul>
<ol>
<li><p>首先针对整个DecorView开启绘制缓存，然后根据传入的Rect进行区域截屏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">snapShotByFinger</span><span class="params">(Activity activity,Rect rect)</span> </span>&#123;</span><br><span class="line">    View view = activity.getWindow().getDecorView();</span><br><span class="line">    view.setDrawingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">    view.buildDrawingCache();</span><br><span class="line">    Bitmap bitmap = view.getDrawingCache();</span><br><span class="line">    Bitmap bm = Bitmap.createBitmap(bitmap, rect.left, rect.top, rect.right-rect.left, rect.bottom-rect.top);</span><br><span class="line">    bitmap.recycle();</span><br><span class="line">    view.destroyDrawingCache();</span><br><span class="line">    <span class="keyword">return</span> bm;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Rect需要通过TouchEvent来获得</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> left,top;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.getAction())&#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:<span class="comment">//手指按下时，记录当前坐标</span></span><br><span class="line">            left = (<span class="keyword">int</span>) event.getRawX();</span><br><span class="line">            top = (<span class="keyword">int</span>) event.getRawY();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:<span class="comment">//手指抬起时，记录当前坐标，然后进行换算，计算Rect；</span></span><br><span class="line">           <span class="keyword">int</span> right = (<span class="keyword">int</span>) event.getRawX();</span><br><span class="line">           <span class="keyword">int</span> bottom = (<span class="keyword">int</span>) event.getRawY();</span><br><span class="line">            Rect rect=<span class="keyword">new</span> Rect();</span><br><span class="line">            <span class="keyword">if</span>(right&gt;left)&#123;</span><br><span class="line">                <span class="keyword">if</span>(bottom&gt;top)&#123;</span><br><span class="line">                    rect.set(left,top,right,bottom);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    rect.set(left,bottom,right,top);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(bottom&gt;top)&#123;</span><br><span class="line">                    rect.set(right,top,left,bottom);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    rect.set(right,bottom,left,top);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//截屏，保存图片</span></span><br><span class="line">            String path = Environment.getExternalStorageDirectory().toString()+<span class="string">"/12345.png"</span>;</span><br><span class="line">            Util.saveBitmap(Util.snapShotByFinger(WebViewActivity.<span class="keyword">this</span>,rect),path);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>暂时就整理这么多东西，关于手指滑动截屏，实际应用中可能还需要处理滑动冲突，或者手指滑动过程中显示路径，这些东西大家自行研究吧。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/05/自定义View系列（一）基本概念/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          自定义View系列（一）基本概念
        
      </div>
    </a>
  
  
    <a href="/2016/04/24/一个图片选择库/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">一个图片选择库</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="长按保存图片以及截屏的几种方式" data-title="Android ImageView长按保存图片及截屏相关知识" data-url="http://www.maplejaw.com/2016/04/25/长按保存图片以及截屏的几种方式/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"maplejaw"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 maplejaw
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>