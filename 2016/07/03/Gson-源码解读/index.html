<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Gson 源码解读 | maplejaw的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="开源库地址：https://github.com/google/gson解读版本：2.7
Gson是一个可以用来将Java对象转换为JSON字符串的Java库。当然，它也可以把JSON字符串转换为等价的Java对象。网上已经有了不少可将Java对象转换成JSON的开源项目。但是，大多数都要求你在Java类中加入注解，如果你无法修改源码的话就比较坑爹了，此外大多数开源库并没有对泛型提供完全的支持。于">
<meta property="og:type" content="article">
<meta property="og:title" content="Gson 源码解读">
<meta property="og:url" content="http://www.maplejaw.com/2016/07/03/Gson-源码解读/index.html">
<meta property="og:site_name" content="maplejaw的技术博客">
<meta property="og:description" content="开源库地址：https://github.com/google/gson解读版本：2.7
Gson是一个可以用来将Java对象转换为JSON字符串的Java库。当然，它也可以把JSON字符串转换为等价的Java对象。网上已经有了不少可将Java对象转换成JSON的开源项目。但是，大多数都要求你在Java类中加入注解，如果你无法修改源码的话就比较坑爹了，此外大多数开源库并没有对泛型提供完全的支持。于">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/69ubbzph20y2hkirftpsom7w/image_1amg2niju16qh14gc1h3odm6k7q13.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/95k1q0oiv80l33iwy59jgn40/image_1amldac2a1qe33br1n9chm1n4s9.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/pk69yimpjfmdkhfvm2d8lejg/image_1amlgoj7n7bv1s5u13f8cv2baqm.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/3v7hbglfw3zul8vh4f9wbgcj/image_1amm2a5vkurd1t6ku4412do8om9.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/3lgovuh2y7o7cd94tuxwrvzr/image_1amn76ilalcs2usk3t1mjddmm9.png">
<meta property="og:updated_time" content="2016-07-03T02:26:08.444Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Gson 源码解读">
<meta name="twitter:description" content="开源库地址：https://github.com/google/gson解读版本：2.7
Gson是一个可以用来将Java对象转换为JSON字符串的Java库。当然，它也可以把JSON字符串转换为等价的Java对象。网上已经有了不少可将Java对象转换成JSON的开源项目。但是，大多数都要求你在Java类中加入注解，如果你无法修改源码的话就比较坑爹了，此外大多数开源库并没有对泛型提供完全的支持。于">
<meta name="twitter:image" content="http://static.zybuluo.com/maplejaw/69ubbzph20y2hkirftpsom7w/image_1amg2niju16qh14gc1h3odm6k7q13.png">
  
    <link rel="alternative" href="/atom.xml" title="maplejaw的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">maplejaw</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不忘初心，方得始终</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/RxJava/" style="font-size: 12px;">RxJava</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/开源库/" style="font-size: 10px;">开源库</a> <a href="/tags/插件化探索/" style="font-size: 16px;">插件化探索</a> <a href="/tags/源码解读/" style="font-size: 18px;">源码解读</a> <a href="/tags/知识整理/" style="font-size: 12px;">知识整理</a> <a href="/tags/自定义View/" style="font-size: 10px;">自定义View</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">maplejaw</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">maplejaw</h1>
			</hgroup>
			
			<p class="header-subtitle">不忘初心，方得始终</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Gson-源码解读" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/03/Gson-源码解读/" class="article-date">
  	<time datetime="2016-07-03T02:06:23.000Z" itemprop="datePublished">2016-07-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Gson 源码解读
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码解读/">源码解读</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>开源库地址：<a href="https://github.com/google/gson" target="_blank" rel="external">https://github.com/google/gson</a><br>解读版本：2.7</p>
<p>Gson是一个可以用来将Java对象转换为JSON字符串的Java库。当然，它也可以把JSON字符串转换为等价的Java对象。网上已经有了不少可将Java对象转换成JSON的开源项目。但是，大多数都要求你在Java类中加入注解，如果你无法修改源码的话就比较坑爹了，此外大多数开源库并没有对泛型提供完全的支持。于是，Gson在这两个重要的设计目标下诞生了。Gson可以作用于任意的Java对象（包括接触不到源码的），与此同时还加入了完整的泛型支持。</p>
<a id="more"></a>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><ul>
<li><p>基本数据类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 序列化为json</span></span><br><span class="line">Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">gson.toJson(<span class="number">1</span>);            <span class="comment">// ==&gt; 1</span></span><br><span class="line">gson.toJson(<span class="string">"abcd"</span>);       <span class="comment">// ==&gt; "abcd"</span></span><br><span class="line">gson.toJson(<span class="keyword">new</span> Long(<span class="number">10</span>)); <span class="comment">// ==&gt; 10</span></span><br><span class="line"><span class="keyword">int</span>[] values = &#123; <span class="number">1</span> &#125;;</span><br><span class="line">gson.toJson(values);       <span class="comment">// ==&gt; [1]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化为java object</span></span><br><span class="line"><span class="keyword">int</span> one = gson.fromJson(<span class="string">"1"</span>, <span class="keyword">int</span>.class);</span><br><span class="line">Integer one = gson.fromJson(<span class="string">"1"</span>, Integer.class);</span><br><span class="line">Long one = gson.fromJson(<span class="string">"1"</span>, Long.class);</span><br><span class="line">Boolean <span class="keyword">false</span> = gson.fromJson(<span class="string">"false"</span>, Boolean.class);</span><br><span class="line">String str = gson.fromJson(<span class="string">"\"abc\""</span>, String.class);</span><br><span class="line">String[] anotherStr = gson.fromJson(<span class="string">"[\"abc\"]"</span>, String[].class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name=<span class="string">"maplejaw"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age=<span class="number">18</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="comment">//无参构造方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化</span></span><br><span class="line"> User obj = <span class="keyword">new</span> User();</span><br><span class="line"> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"> String json = gson.toJson(obj);  <span class="comment">// ==&gt; json is &#123;"name":"maplejaw","age":18&#125;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line"> User obj2 = gson.fromJson(json, User.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>泛型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Type type= <span class="keyword">new</span> TypeToken&lt;List&lt;User&gt;&gt;()&#123;&#125;.getType();</span><br><span class="line">List&lt;User&gt; list = gson.fromJson(json, type);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Gson</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Gson gson=<span class="keyword">new</span> GsonBuilder()</span><br><span class="line">               .setLenient() <span class="comment">//设置宽松的容错性</span></span><br><span class="line">               .setPrettyPrinting() <span class="comment">//设置漂亮的打印（打印出来的有缩进风格）</span></span><br><span class="line">               .setVersion(..) <span class="comment">//设置当前版本号</span></span><br><span class="line">               ...</span><br><span class="line">               .create();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Gson的基本用法如上所示，使用起来比较简便，一般情况下也已经够用了。需要注意的是，Java对象一定要有一个无参构造方法，这是Gson实例化对象的关键（自定义实例后面介绍）。此外，Java对象中并不要求有set/get方法。一般只要了解以上基本用法就能够应付绝大多数情况了，如果想深入了解一些高级用法，请继续往下阅读源码解读。</p>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><h3 id="Gson中的5个注解"><a href="#Gson中的5个注解" class="headerlink" title="Gson中的5个注解"></a>Gson中的5个注解</h3><ul>
<li><p>@Expose<br>表示某个成员变量暴露于JSON序列化/反序列化。只需在GsonBuilder中配置<code>excludeFieldsWithoutExposeAnnotation()</code>时才会生效。当配置过后，只有使用了<code>@Expose</code>注解的成员变量才会参与序列化/反序列化工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Expose</span></span><br><span class="line">  <span class="keyword">private</span> String firstName;<span class="comment">//参与序列化(JAVA对象转为JSON)/反序列化（JSON转为JAVA对象）</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Expose</span>(serialize = <span class="keyword">false</span>) </span><br><span class="line">  <span class="keyword">private</span> String lastName;<span class="comment">//参与反序列化</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Expose</span> (serialize = <span class="keyword">false</span>, deserialize = <span class="keyword">false</span>) </span><br><span class="line">  <span class="keyword">private</span> String emailAddress; <span class="comment">//不参与</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String password;<span class="comment">//不参与</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@SerializedName<br>表示某个成员变量序列化/反序列化的名字，无需在GsonBuilder中配置就能生效,甚至会覆盖掉<code>FieldNamingPolicy</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  <span class="meta">@SerializedName</span>(<span class="string">"name"</span>) <span class="comment">//a =&gt; name</span></span><br><span class="line">  String a;</span><br><span class="line">  <span class="meta">@SerializedName</span>(value=<span class="string">"name1"</span>, alternate=&#123;<span class="string">"name2"</span>, <span class="string">"name3"</span>&#125;) </span><br><span class="line">  String b;</span><br><span class="line">  </span><br><span class="line">  String c;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyClass</span><span class="params">(String a, String b, String c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.a = a;</span><br><span class="line">    <span class="keyword">this</span>.b = b;</span><br><span class="line">    <span class="keyword">this</span>.c = c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当使用了该注解后，此时序列化/反序列化的情况如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> MyClass target = new MyClass(&quot;v1&quot;, &quot;v2&quot;, &quot;v3&quot;);</span><br><span class="line">Gson gson = new Gson();</span><br><span class="line">String json = gson.toJson(target);</span><br><span class="line"> //===== 输入的json如下 =====</span><br><span class="line">&#123;&quot;name&quot;:&quot;v1&quot;,&quot;name1&quot;:&quot;v2&quot;,&quot;c&quot;:&quot;v3&quot;&#125;</span><br><span class="line">//同理，以下的json数据都能成功反序列化为MyClass。</span><br><span class="line"> &#123;&quot;name&quot;:&quot;v1&quot;,&quot;name1&quot;:&quot;v2&quot;,&quot;c&quot;:&quot;v3&quot;&#125;</span><br><span class="line"> &#123;&quot;name&quot;:&quot;v1&quot;,&quot;name2&quot;:&quot;v2&quot;,&quot;c&quot;:&quot;v3&quot;&#125;</span><br><span class="line"> &#123;&quot;name&quot;:&quot;v1&quot;,&quot;name3&quot;:&quot;v2&quot;,&quot;c&quot;:&quot;v3&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>这个注解有什么好处呢？众所周知，在Java中的变量命名规则须遵守驼峰原则，但是，如果后台使用的是php等其他语言，将导致命名规则不一致；又或者因为其他原因导致多条json只有一个字段不一致，总不能建立多个实体类吧？这时候这个注解就派上用场了。</p>
</li>
<li><p>@Since<br>表示某个成员变量从哪个版本开始生效，只在GsonBuilder中配置了<code>setVersion()</code>时才会生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> String firstName;<span class="comment">//一直参与</span></span><br><span class="line"> <span class="keyword">private</span> String lastName;<span class="comment">//一直参与</span></span><br><span class="line"> <span class="meta">@Since</span>(<span class="number">1.0</span>) <span class="keyword">private</span> String emailAddress; <span class="comment">//当前版本&gt;=1.0时才会参与序列化/反序列化，否则忽略</span></span><br><span class="line"> <span class="meta">@Since</span>(<span class="number">1.0</span>) <span class="keyword">private</span> String password;<span class="comment">//当前版本&gt;=1.0时才会参与序列化/反序列化，否则忽略</span></span><br><span class="line"> <span class="meta">@Since</span>(<span class="number">1.1</span>) <span class="keyword">private</span> Address address;<span class="comment">//当前版本&gt;=1.1时才会参与序列化/反序列化，否则忽略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Until<br>表示某个成员变量从哪个版本开始失效，只在GsonBuilder中配置了<code>setVersion()</code>时才会生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> String firstName;<span class="comment">//一直参与</span></span><br><span class="line"> <span class="keyword">private</span> String lastName;<span class="comment">//一直参与</span></span><br><span class="line"> <span class="meta">@Until</span>(<span class="number">1.1</span>) <span class="keyword">private</span> String emailAddress;<span class="comment">//当前版本&lt;=1.1时参加序列化/反序列化</span></span><br><span class="line"> <span class="meta">@Until</span>(<span class="number">1.1</span>) <span class="keyword">private</span> String password;<span class="comment">//当前版本&lt;=1.1时参加序列化/反序列化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>@JsonAdapter<br>表示在某一个成员变量或者类上使用TypeAdapter。至于TypeAdapter是什么东东，后面介绍。举个例子：<br>假如有个User类如此下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">final</span> String firstName, lastName;</span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">       <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>准备编写一个UserJsonAdapter。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserJsonAdapter</span> <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, User user)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     out.beginObject();</span><br><span class="line">     out.name(<span class="string">"name"</span>);</span><br><span class="line">     out.value(user.firstName + <span class="string">" "</span> + user.lastName);</span><br><span class="line">     out.endObject();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span> </span><br><span class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     in.beginObject();</span><br><span class="line">     in.nextName();</span><br><span class="line">     String[] nameParts = in.nextString().split(<span class="string">" "</span>);</span><br><span class="line">     in.endObject();</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> User(nameParts[<span class="number">0</span>], nameParts[<span class="number">1</span>]);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>将UserJsonAdapter应用到属性：此时，Gadget中的User，将会按照UserJsonAdapter来进行序列化/反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Gadget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@JsonAdapter</span>(UserJsonAdapter.class)</span><br><span class="line">  <span class="keyword">public</span> User user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将UserJsonAdapter应用到类：此时，在序列化/反序列User对象时，都会按照UserJsonAdapter来执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@JsonAdapter</span>(UserJsonAdapter.class)</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">final</span> String firstName, lastName;</span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">       <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="JsonReader-JsonWriter"><a href="#JsonReader-JsonWriter" class="headerlink" title="JsonReader/JsonWriter"></a>JsonReader/JsonWriter</h3><p>在Gson中，Java对象与JSON字符串之间的转换是通过字符流来进行操作的。JsonReader继承于Reader用来读取字符，JsonWriter继承于Writer用来写入字符。<br>假如，现在有如下一段JSON数据用来表示一个用户列表。<code>name</code>为名字,<code>age</code>为年龄,<code>geo</code>为定位的经纬度。如何使用JsonReader转为java对象？<br><img src="http://static.zybuluo.com/maplejaw/69ubbzph20y2hkirftpsom7w/image_1amg2niju16qh14gc1h3odm6k7q13.png" alt="image_1amg2niju16qh14gc1h3odm6k7q13.png-11.3kB"><br>首先查看一下json的结构，不难发现最外层是一个数组。于是，我们定义出如下<code>readJsonStream</code>从Stream（流）中读取用户列表，读取完毕后，务必记得关闭流。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//从流中读取List&lt;User&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">readJsonStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     JsonReader reader = <span class="keyword">new</span> JsonReader(<span class="keyword">new</span> InputStreamReader(in, <span class="string">"UTF-8"</span>));</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> readUserArray(reader);<span class="comment">//读取用户列表</span></span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       reader.close();<span class="comment">//关闭流</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取List&lt;User&gt;</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">readUserArray</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">     reader.beginArray();<span class="comment">//开始读取数组</span></span><br><span class="line">     <span class="keyword">while</span> (reader.hasNext()) &#123;<span class="comment">//是否还有下个元素</span></span><br><span class="line">       users.add(readUser(reader));<span class="comment">//读取下个元素</span></span><br><span class="line">     &#125;</span><br><span class="line">     reader.endArray();<span class="comment">//结束读取数组</span></span><br><span class="line">     <span class="keyword">return</span> users;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//读取User对象  </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">readUser</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       String name = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">int</span> age = -<span class="number">1</span>;</span><br><span class="line">       List&lt;Double&gt; geo=<span class="keyword">null</span>;</span><br><span class="line">      reader.beginObject();<span class="comment">//开始读取对象</span></span><br><span class="line">     <span class="keyword">while</span> (reader.hasNext()) &#123;<span class="comment">//是否还有下个元素</span></span><br><span class="line">       String name = reader.nextName();<span class="comment">//读取下一个json属性名</span></span><br><span class="line">        <span class="comment">//判断属性名是哪一个</span></span><br><span class="line">       <span class="keyword">if</span> (name.equals(<span class="string">"name"</span>)) &#123;</span><br><span class="line">           name = reader.nextString();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"age"</span>)) &#123;</span><br><span class="line">           age = reader.nextInt();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">"geo"</span>)&amp;&amp; reader.peek() != JsonToken.NULL) &#123;</span><br><span class="line">          geo = readDoublesArray(reader);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         reader.skipValue();<span class="comment">//忽略没有匹配到内容的值</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     reader.endObject();<span class="comment">//结束读取对象</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> User(name, age,geo);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//读取经纬度</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;Double&gt; <span class="title">readDoublesArray</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     List&lt;Double&gt; doubles = <span class="keyword">new</span> ArrayList&lt;Double&gt;();</span><br><span class="line"></span><br><span class="line">     reader.beginArray();</span><br><span class="line">     <span class="keyword">while</span> (reader.hasNext()) &#123;</span><br><span class="line">       doubles.add(reader.nextDouble());</span><br><span class="line">     &#125;</span><br><span class="line">     reader.endArray();</span><br><span class="line">     <span class="keyword">return</span> doubles;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们不难发现如下规律，每次读取数组或者对象之前，都必须调用<code>beginObject()</code>或者<code>beginArray()</code>,读完相应内容后，也必须调用<code>endObject()</code>或者<code>endArray()</code>。<code>reader.hasNext()</code>用来判断是否还有下一个元素，然后调用<code>nextName</code>来取下一个属性名，以及一系列的<code>nextXXX</code>来取相应的值。<br>上面介绍的是将json字符串转换为java对象的用法，现在来看看如何使用JsonWriter来讲java对象转为json字符串。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//将List&lt;User&gt;写入流中</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeJsonStream</span><span class="params">(OutputStream out, List&lt;User&gt; users)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   JsonWriter writer = <span class="keyword">new</span> JsonWriter(<span class="keyword">new</span> OutputStreamWriter(out, <span class="string">"UTF-8"</span>));</span><br><span class="line">   writer.setIndent(<span class="string">"    "</span>);<span class="comment">//设置缩进风格(设置后写入的字符串保持缩进风格，如果没有设置，将会顶格打印）</span></span><br><span class="line">   writeUsersArray(writer, users);<span class="comment">//写入List&lt;User&gt;</span></span><br><span class="line">   writer.close();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//写入List&lt;User&gt;</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeUsersArray</span><span class="params">(JsonWriter writer, List&lt;User&gt; users)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   writer.beginArray();<span class="comment">//开始写入数组</span></span><br><span class="line">   <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">     writeUser(writer, user);</span><br><span class="line">   &#125;</span><br><span class="line">   writer.endArray();<span class="comment">//结束写入数组</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">//写入User</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeUser</span><span class="params">(JsonWriter writer, User user)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   writer.beginObject();<span class="comment">//开始写入对象</span></span><br><span class="line">   writer.name(<span class="string">"name"</span>).value(user.getName());</span><br><span class="line">   writer.name(<span class="string">"age"</span>).value(user.getAge());</span><br><span class="line">   <span class="keyword">if</span> (user.getGeo() != <span class="keyword">null</span>) &#123;</span><br><span class="line">     writer.name(<span class="string">"geo"</span>);</span><br><span class="line">     writeDoublesArray(writer, user.getGeo());</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     writer.name(<span class="string">"geo"</span>).nullValue();</span><br><span class="line">   &#125;</span><br><span class="line">   writer.endObject();<span class="comment">//结束写入对象</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeDoublesArray</span><span class="params">(JsonWriter writer, List&lt;Double&gt; doubles)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   writer.beginArray();</span><br><span class="line">   <span class="keyword">for</span> (Double value : doubles) &#123;</span><br><span class="line">     writer.value(value);</span><br><span class="line">   &#125;</span><br><span class="line">   writer.endArray();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>JsonWriter用来写入JSON字符串的规则和JsonWriter大相径庭，每次写入数组或者对象之前，都必须调用<code>beginObject()</code>或者<code>beginArray()</code>,写完相应内容后，也必须调用<code>endObject()</code>或者<code>endArray()</code>。<code>name(xx)</code>用来写入名字，<code>value(XX)</code>用来写入值。<br>接下来，深入浅出解析源码！stream包的结构如下：<br><img src="http://static.zybuluo.com/maplejaw/95k1q0oiv80l33iwy59jgn40/image_1amldac2a1qe33br1n9chm1n4s9.png" alt="image_1amldac2a1qe33br1n9chm1n4s9.png-8.6kB"><br>枚举类<code>JsonToken</code>的源码如下，主要用于表示JSON字符串中的名字/值的结构。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> JsonToken &#123;</span><br><span class="line"></span><br><span class="line">  BEGIN_ARRAY,<span class="comment">//JSON array开始</span></span><br><span class="line"></span><br><span class="line">  END_ARRAY,<span class="comment">//JSON array结束</span></span><br><span class="line"></span><br><span class="line">  BEGIN_OBJECT,<span class="comment">//JSON object开始</span></span><br><span class="line"></span><br><span class="line">  END_OBJECT,<span class="comment">//JSON object结束</span></span><br><span class="line"></span><br><span class="line">  NAME,<span class="comment">//JSON 属性名,JsonReader#nextName/JsonWriter#name</span></span><br><span class="line"></span><br><span class="line">  STRING,<span class="comment">//JSON 字符串</span></span><br><span class="line"></span><br><span class="line">  NUMBER,<span class="comment">//JSON 数字，代表java中double,long,int</span></span><br><span class="line">  </span><br><span class="line">  BOOLEAN,<span class="comment">//JSON 布尔值</span></span><br><span class="line"></span><br><span class="line">  NULL, <span class="comment">//表示 null</span></span><br><span class="line"></span><br><span class="line">  END_DOCUMENT <span class="comment">//表示JSON流的结尾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JsonScope是一个常量类，元素词法作用域。用来标识JsonReader/JsonWriter现在读/写到哪了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonScope</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EMPTY_ARRAY = <span class="number">1</span>;<span class="comment">//没有元素的数组（相当于之前刚读了“[”），下一个元素一定不是逗号。</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NONEMPTY_ARRAY = <span class="number">2</span>;<span class="comment">//非空数组（至少已经有一个元素），下一个元素不是逗号就是“]”</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EMPTY_OBJECT = <span class="number">3</span>;<span class="comment">//空对象（刚读到“&#123;”,一个name/value对都没有），下一个一定不是逗号。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DANGLING_NAME = <span class="number">4</span>;<span class="comment">//名字，下一个元素一定是值。</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NONEMPTY_OBJECT = <span class="number">5</span>;<span class="comment">//非空对象（至少一个name/value对），下一个元素不是逗号就是“&#125;”</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EMPTY_DOCUMENT = <span class="number">6</span>;<span class="comment">//空文档，初识状态，啥也没读</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NONEMPTY_DOCUMENT = <span class="number">7</span>;<span class="comment">//文档中有一个顶级的数组/对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOSED = <span class="number">8</span>;<span class="comment">//文档已被关闭</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="JsonWriter"><a href="#JsonWriter" class="headerlink" title="JsonWriter"></a>JsonWriter</h4><p>JsonWriter，用于将Java对象写为JSON字符串。使用前我们可以进行一些默认的配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置缩进符号，只要你设置了缩进符号，打印出来的字符串将会拥有缩进风格，非常漂亮</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setIndent</span><span class="params">(String indent)</span></span><br><span class="line"><span class="comment">//设置宽松的容错性（顶级值可以不是为object/array，数字可以为无穷）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setLenient</span><span class="params">(<span class="keyword">boolean</span> lenient)</span></span><br><span class="line"><span class="comment">//html转义</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setHtmlSafe</span><span class="params">(<span class="keyword">boolean</span> htmlSafe)</span></span><br><span class="line"><span class="comment">//序列化空，默认true</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setSerializeNulls</span><span class="params">(<span class="keyword">boolean</span> serializeNulls)</span></span></span><br></pre></td></tr></table></figure></p>
<p>JsonWriter使用一个数组来保存当前的写入状态（就是标识写到哪了），JsonScope中已经介绍过了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] stack = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">32</span>];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> stackSize = <span class="number">0</span>;</span><br><span class="line">&#123;</span><br><span class="line">  push(EMPTY_DOCUMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意stack并没有定死32的长度，当写满时将会扩大一倍。使用<code>push</code>来保存当前写入状态，<code>peek</code>查看当前状态。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将当前状态保存栈顶</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> newTop)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (stackSize == stack.length) &#123;<span class="comment">//如果满了就扩大一倍</span></span><br><span class="line">    <span class="keyword">int</span>[] newStack = <span class="keyword">new</span> <span class="keyword">int</span>[stackSize * <span class="number">2</span>];</span><br><span class="line">    System.arraycopy(stack, <span class="number">0</span>, newStack, <span class="number">0</span>, stackSize);</span><br><span class="line">    stack = newStack;</span><br><span class="line">  &#125;</span><br><span class="line">  stack[stackSize++] = newTop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查看栈顶的值</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (stackSize == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"JsonWriter is closed."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> stack[stackSize - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在写一个对象之前，必须使用<code>beginObject()</code>。一定很好奇<code>beginObject()</code>做了什么，当时还不忙着看，先来看看怎么写入name/value的。<br><code>name(XX)</code>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonWriter <span class="title">name</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name == null"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (deferredName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (stackSize == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"JsonWriter is closed."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  deferredName = name;<span class="comment">//赋值给deferredName</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看完源码不由觉得有点失望，只是赋值给了deferredName，其他什么事也没做。那么到底什么时候写入name的。这还得从写入value看起。<br><code>value(XX)</code>有很多重载函数。<br><img src="http://static.zybuluo.com/maplejaw/pk69yimpjfmdkhfvm2d8lejg/image_1amlgoj7n7bv1s5u13f8cv2baqm.png" alt="image_1amlgoj7n7bv1s5u13f8cv2baqm.png-9.9kB"><br>我们只看<code>value(String)</code>这种。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonWriter <span class="title">value</span><span class="params">(String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;<span class="comment">//如果空的话，写入空值</span></span><br><span class="line">    <span class="keyword">return</span> nullValue();</span><br><span class="line">  &#125;</span><br><span class="line">  writeDeferredName();<span class="comment">//写入name。</span></span><br><span class="line">  beforeValue();<span class="comment">//写入“:”（会对上次状态进行校验）</span></span><br><span class="line">  string(value);<span class="comment">//写入value（会对特殊字符进行转码）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过<code>writeDeferredName</code>写入名字，<code>beforeValue</code>写入<code>:</code>,<code>string</code>写入真正的值。当然<code>writeDeferredName</code>也不是说直接写入name，而是先<code>beforeName</code>进行状态校验,换行，替换状态，按需写入<code>,</code>，然后使用<code>string</code>写入name值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeDeferredName</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (deferredName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    beforeName();<span class="comment">//校验等</span></span><br><span class="line">    string(deferredName);<span class="comment">//写入名字</span></span><br><span class="line">    deferredName = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在来看看<code>beginObject</code>,如果该对象是name/value中的value,那么writeDeferredName用来写入name。<code>open</code>写入<code>{</code>以及更改栈顶状态。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> JsonWriter <span class="title">beginObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  writeDeferredName();<span class="comment">//写入name（如果有）</span></span><br><span class="line">  <span class="keyword">return</span> open(EMPTY_OBJECT, <span class="string">"&#123;"</span>); <span class="comment">//写入“&#123;”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>endObject</code>则是调用<code>close</code>来写入<code>}</code>,传入的<code>EMPTY_OBJECT,EMPTY_OBJECT</code>用来比较是在哪种状态下进行关闭的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JsonWriter <span class="title">endObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> close(EMPTY_OBJECT, EMPTY_OBJECT, <span class="string">"&#125;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至于<code>beginArray/endArray</code>的源码这里就不赘述了。</p>
<h4 id="JsonReader"><a href="#JsonReader" class="headerlink" title="JsonReader"></a>JsonReader</h4><p>JsonReader，用于将JSON字符串转为Java对象。<br>JsonReader中的<code>setLenient</code>的容错性那可是非常厉害。以下错误都能被忽略。</p>
<ul>
<li><code>)]}&#39;\n</code> 前缀</li>
<li>多个顶级值</li>
<li>顶级值不是 object/array类型</li>
<li>数字类型为无穷数，或者不是个数字</li>
<li>一行的结尾存在//或者 #注释</li>
<li>C语言风格的注释/<em>…</em>/</li>
<li>name用了单引号或者没用引号</li>
<li>string用了单引号或者没用引号</li>
<li>数组元素的分隔符用了;而不是,</li>
<li>name和value不是用：分隔，而是用=或=&gt;</li>
<li>name/value对之间不是逗号分隔，而是;分隔</li>
</ul>
<p>和JsonWriter一样，也使用一个数组stack来保存当前的读取到的字符的类型和状态。其中引入了一系列的<code>PEEKED_XX</code>int常量来记录读取的字符类型。由于篇幅问题，JsonReader就不深入研究了，以下列出JsonReader中的核心方法。</p>
<ul>
<li><code>fillBuffer</code> 用来读取字符到<code>buffer</code>数组中</li>
<li><code>nextNonWhitespace</code> 用来读取非空格/注释/换行等字符</li>
<li><code>peek()</code> 查看元素类型，对应于JsonToken中的值。</li>
<li><code>doPeek()</code> 内部使用了<code>nextNonWhitespace</code>读取一个字符，然后设置当前的读取的字符类型。</li>
<li><code>hasNext</code> object/array中是不是还有下一个元素</li>
<li><code>nextName</code>读取下一个name</li>
<li><code>nextString/nextInt/nextBoolean/nextLong/nextDouble/nextNull</code>用来读取下一个对应的值。</li>
<li><code>skipValue</code> 跳过下一个value</li>
<li><code>nextQuotedValue/nextUnquotedValue</code>用来读取下一个单引号/双引号没有引号括起来的name或者string value</li>
<li><code>beginObject/endObject/beginArray/endArray</code> 用来消费下一个对应类型的字符</li>
</ul>
<h3 id="Gson中的泛型"><a href="#Gson中的泛型" class="headerlink" title="Gson中的泛型"></a>Gson中的泛型</h3><p>在了解Gson中的泛型前，我们来看两个类，\$Gson\$Types和\$Gson\$Preconditions。<br>\$Gson\$Types，专门用来处理泛型类型。核心源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//规范化类型</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Type <span class="title">canonicalize</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;<span class="comment">//class</span></span><br><span class="line">    Class&lt;?&gt; c = (Class&lt;?&gt;) type;</span><br><span class="line">    <span class="keyword">return</span> c.isArray() ? <span class="keyword">new</span> GenericArrayTypeImpl(canonicalize(c.getComponentType())) : c;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;<span class="comment">//泛型</span></span><br><span class="line">    ParameterizedType p = (ParameterizedType) type;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ParameterizedTypeImpl(p.getOwnerType(),</span><br><span class="line">        p.getRawType(), p.getActualTypeArguments());</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType) &#123;<span class="comment">//数组类型</span></span><br><span class="line">    GenericArrayType g = (GenericArrayType) type;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GenericArrayTypeImpl(g.getGenericComponentType());</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType) &#123;<span class="comment">//通配符类型</span></span><br><span class="line">    WildcardType w = (WildcardType) type;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WildcardTypeImpl(w.getUpperBounds(), w.getLowerBounds());</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// type is either serializable as-is or unsupported</span></span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取原始类型</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getRawType(Type type) &#123;</span><br><span class="line">  <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class&lt;?&gt;) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (Class&lt;?&gt;) type;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">    <span class="comment">//泛型</span></span><br><span class="line">    ParameterizedType parameterizedType = (ParameterizedType) type;</span><br><span class="line"></span><br><span class="line">    Type rawType = parameterizedType.getRawType();</span><br><span class="line">    checkArgument(rawType <span class="keyword">instanceof</span> Class);</span><br><span class="line">    <span class="keyword">return</span> (Class&lt;?&gt;) rawType;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> GenericArrayType) &#123;</span><br><span class="line">    <span class="comment">//数组类型</span></span><br><span class="line">    Type componentType = ((GenericArrayType)type).getGenericComponentType();</span><br><span class="line">    <span class="keyword">return</span> Array.newInstance(getRawType(componentType), <span class="number">0</span>).getClass();</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">         <span class="comment">//类型变量的上边界是Object</span></span><br><span class="line">         <span class="keyword">return</span> Object.class;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType) &#123;</span><br><span class="line">     <span class="comment">//返回上边界</span></span><br><span class="line">    <span class="keyword">return</span> getRawType(((WildcardType) type).getUpperBounds()[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    String className = type == <span class="keyword">null</span> ? <span class="string">"null"</span> : type.getClass().getName();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Expected a Class, ParameterizedType, or "</span></span><br><span class="line">        + <span class="string">"GenericArrayType, but &lt;"</span> + type + <span class="string">"&gt; is of type "</span> + className);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>canonicalize这个方法中返回了一系列的XXImpl，其实只是实现了java.io.Serializable接口，重写了equal方法而已。其中ParameterizedType/GenericArrayType/WildcardType,熟悉泛型的应该不会陌生，这里就不赘述了。</p>
<p>\$Gson\$Preconditions，这个类用于条件校验，源码很是简洁。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Gson</span>$<span class="title">Preconditions</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $Gson$Preconditions() &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">checkNotNull</span><span class="params">(T obj)</span> </span>&#123;<span class="comment">//校验非空</span></span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkArgument</span><span class="params">(<span class="keyword">boolean</span> condition)</span> </span>&#123;<span class="comment">//校验是不是满足条件</span></span><br><span class="line">    <span class="keyword">if</span> (!condition) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在回过来了解Gson中的泛型，Gson中用TypeToken来表示泛型。<br>源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeToken</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Class&lt;? <span class="keyword">super</span> T&gt; rawType;<span class="comment">//T的原始类型</span></span><br><span class="line">  <span class="keyword">final</span> Type type; <span class="comment">//T 的类型</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hashCode;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">TypeToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//获取父类泛型的参数类型</span></span><br><span class="line">    <span class="keyword">this</span>.type = getSuperclassTypeParameter(getClass());</span><br><span class="line">    <span class="comment">//获取原始类型</span></span><br><span class="line">    <span class="keyword">this</span>.rawType = (Class&lt;? <span class="keyword">super</span> T&gt;) $Gson$Types.getRawType(type);</span><br><span class="line">    <span class="keyword">this</span>.hashCode = type.hashCode();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> Class&lt;? <span class="keyword">super</span> T&gt; getRawType() &#123;</span><br><span class="line">    <span class="keyword">return</span> rawType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Type <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了部分源码</span></span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>由于Java中只能通过<code>getGenericSuperclass</code>获取父类泛型类型，所以TypeToken必须new出一个子类<code>Type type= new TypeToken&lt;List&lt;User&gt;&gt;(){}.getType();</code>来使用。<br><code>getSuperclassTypeParameter</code>的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Type <span class="title">getSuperclassTypeParameter</span><span class="params">(Class&lt;?&gt; subclass)</span> </span>&#123;</span><br><span class="line">  Type superclass = subclass.getGenericSuperclass();<span class="comment">//获取父类泛型类型</span></span><br><span class="line">  <span class="keyword">if</span> (superclass <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Missing type parameter."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ParameterizedType parameterized = (ParameterizedType) superclass;</span><br><span class="line">  <span class="comment">//获取泛型参数类型，即T的类型</span></span><br><span class="line">  <span class="keyword">return</span> $Gson$Types.canonicalize(parameterized.getActualTypeArguments()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="JsonElement"><a href="#JsonElement" class="headerlink" title="JsonElement"></a>JsonElement</h3><p>JsonElement，一个抽象类，代表着JSON中的元素类型。可以表示JsonObject，JsonArray，JsonPrimitive，JsonNull。换言之，Gson中的JsonObject/JsonArray/JsonPrimitive/JsonNull继承于JsonElement。JsonElement也提供了一系列的<code>getAsXXX</code>方法来获取元素。<br>我们着重看一下JsonPrimitive，JsonPrimitive代表着java中的基本数据类型。可以看出，通过构造方法进行赋值，然后通过<code>getAsXX</code>取值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonPrimitive</span> <span class="keyword">extends</span> <span class="title">JsonElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//基本类型列表如下</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] PRIMITIVE_TYPES = &#123; <span class="keyword">int</span>.class, <span class="keyword">long</span>.class, <span class="keyword">short</span>.class,</span><br><span class="line">      <span class="keyword">float</span>.class, <span class="keyword">double</span>.class, <span class="keyword">byte</span>.class, <span class="keyword">boolean</span>.class, <span class="keyword">char</span>.class, Integer.class, Long.class,</span><br><span class="line">      Short.class, Float.class, Double.class, Byte.class, Boolean.class, Character.class &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//值</span></span><br><span class="line">  <span class="keyword">private</span> Object value;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonPrimitive</span><span class="params">(Boolean bool)</span> </span>&#123;</span><br><span class="line">    setValue(bool);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//赋值数字类型</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JsonPrimitive</span><span class="params">(Number number)</span> </span>&#123;</span><br><span class="line">    setValue(number);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//赋值String</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JsonPrimitive</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">    setValue(string);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//赋值字符</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JsonPrimitive</span><span class="params">(Character c)</span> </span>&#123;</span><br><span class="line">    setValue(c);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//赋值给value</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setValue</span><span class="params">(Object primitive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (primitive <span class="keyword">instanceof</span> Character) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">char</span> c = ((Character) primitive).charValue();</span><br><span class="line">      <span class="keyword">this</span>.value = String.valueOf(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      $Gson$Preconditions.checkArgument(primitive <span class="keyword">instanceof</span> Number</span><br><span class="line">              || isPrimitiveOrString(primitive));</span><br><span class="line">      <span class="keyword">this</span>.value = primitive;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了部分源码</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Gson中的TypeAdapter"><a href="#Gson中的TypeAdapter" class="headerlink" title="Gson中的TypeAdapter"></a>Gson中的TypeAdapter</h3><p>还记得介绍注解时提到的TypeAdapter吗？TypeAdapter是一个抽象类，可以用来自定义类型转换。源码如下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAdapter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//抽象方法，写value（an array, object, string, number, boolean or null）</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//抽象方法，读value</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//包装方法，帮你处理了空值，你可以不用担心空值问题</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> TypeAdapter&lt;T&gt; <span class="title">nullSafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TypeAdapter&lt;T&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;<span class="comment">//如果为空，写入null</span></span><br><span class="line">          out.nullValue();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          TypeAdapter.<span class="keyword">this</span>.write(out, value);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">read</span><span class="params">(JsonReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reader.peek() == JsonToken.NULL) &#123;</span><br><span class="line">          reader.nextNull();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TypeAdapter.<span class="keyword">this</span>.read(reader);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了部分源码</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们只需继承于TypeAdapter，实现相应方法就能实现自己的TypeAdapter，前面我们介绍了使用注解方法来使用TypeAdapter，现在来讲一下在GsonBuilder中如何使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Gson gson= <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">              .registerTypeAdapter(XX.class,<span class="keyword">new</span> XXTypeAdapter())</span><br><span class="line">              .create();</span><br></pre></td></tr></table></figure></p>
<p>在GsonBuilder中使用registerTypeAdapter配置后，就不需要使用相关注解了。那么问题来了，如果GsonBuilder和注解为同一个类配置了不同的TypeAdapter会发生什么状况？我可以很负责任的告诉你，注解的优先级是最高的。<br>此外，我们之前在编写UserJsonAdapter时没有处理空值情况，很容易会抛出异常，那怎么办？一种是自己处理空值情况，将代码改成如下形式。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserJsonAdapter</span> <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, User user)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;<span class="comment">//判断空值</span></span><br><span class="line">    out.nullValue();</span><br><span class="line">    retrun;</span><br><span class="line">  &#125;</span><br><span class="line"> out.beginObject();</span><br><span class="line"> out.name(<span class="string">"name"</span>);</span><br><span class="line"> out.value(user.firstName + <span class="string">" "</span> + user.lastName);</span><br><span class="line"> out.endObject();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (reader.peek() == JsonToken.NULL) &#123;<span class="comment">//判断空值</span></span><br><span class="line">         reader.nextNull();</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> in.beginObject();</span><br><span class="line"> in.nextName();</span><br><span class="line"> String[] nameParts = in.nextString().split(<span class="string">" "</span>);</span><br><span class="line"> in.endObject();</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> User(nameParts[<span class="number">0</span>], nameParts[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二种方法，使用<code>nullSafe</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Gson gson= <span class="keyword">new</span> GsonBuilder()</span><br><span class="line">               .registerTypeAdapter(User.class,<span class="keyword">new</span> UserJsonAdapter().nullSafe())</span><br><span class="line">               .create();</span><br></pre></td></tr></table></figure></p>
<p>TypeAdapterFactory是一个创造TypeAdapter的工厂，用来创造一些相似类型的TypeAdapter。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TypeAdapterFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, TypeToken&lt;T&gt; type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继承TypeAdapter，需要重写<code>write</code>和<code>read</code>相关方法，可是只想处理序列化和反序列化中的一种该怎么办？那么接下来就该介绍<code>JsonSerializer</code>和<code>JsonDeserializer</code>接口了。可以在<code>@JsonAdapter</code>注解和<code>registerTypeAdapter</code>中注册使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//序列化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JsonSerializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> JsonElement <span class="title">serialize</span><span class="params">(T src, Type typeOfSrc, JsonSerializationContext context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JsonDeserializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">deserialize</span><span class="params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span><span class="keyword">throws</span> JsonParseException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="序列化策略"><a href="#序列化策略" class="headerlink" title="序列化策略"></a>序列化策略</h3><ul>
<li><p>LongSerializationPolicy<br>枚举类，指定长整型的序列化类型，默认有DEFAULT，STRING两种类型，可继承它实现其他类型</p>
</li>
<li><p>InstanceCreator 实例创造器<br>当反序列化时需要实例化对象，但是假如该对象没有默认构造方法怎么吧？那么就自定义自己的实例创造器。InstanceCreator一般配合ConstructorConstructor一起使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InstanceCreator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">createInstance</span><span class="params">(Type type)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInstanceCreator</span> <span class="keyword">implements</span> <span class="title">InstanceCreator</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> User <span class="title">createInstance</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="keyword">null</span>, -<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>FieldNamingStrategy<br>提供了一个自定义的字段命名机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FieldNamingStrategy</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">translateName</span><span class="params">(Field f)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>FieldNamingPolicy<br>一个枚举类，实现了FieldNamingStrategy，提供了一些默认的字段命名机制，<code>IDENTITY</code>：原始机制；<code>UPPER_CAMEL_CASE</code>：首字母大写的驼峰映射；<code>UPPER_CAMEL_CASE_WITH_SPACES</code>：用空格分隔的大写驼峰<code>LOWER_CASE_WITH_UNDERSCORES</code>：下划线相连的小写映射;<code>LOWER_CASE_WITH_DASHES</code>:虚线相连的小写映射。</p>
</li>
<li><p>FieldAttributes<br>用来存取字段的属性：<code>getName</code>获取字段名，<code>getDeclaringClass</code>获取声明的类，<code>getDeclaredType</code>获取字段的声明类型，<code>getAnnotation</code>获取注解。</p>
</li>
<li><p>ExclusionStrategy<br>一个用于定义排除策略的的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExclusionStrategy</span> </span>&#123;</span><br><span class="line">  <span class="comment">//是否应该忽略该属性</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldSkipField</span><span class="params">(FieldAttributes f)</span></span>;</span><br><span class="line">  <span class="comment">//是否应该忽略该类</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldSkipClass</span><span class="params">(Class&lt;?&gt; clazz)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><p>Excluder 排除器，主要用于根据策略和注解来判断哪些字段应该被忽略。<br>属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> IGNORE_VERSIONS = -<span class="number">1.0</span>d;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Excluder DEFAULT = <span class="keyword">new</span> Excluder();</span><br><span class="line">  <span class="comment">//默认忽略版本号</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">double</span> version = IGNORE_VERSIONS;</span><br><span class="line">  <span class="comment">//默认以下修饰符的字段会被忽略</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> modifiers = Modifier.TRANSIENT | Modifier.STATIC;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> serializeInnerClasses = <span class="keyword">true</span>;<span class="comment">//序列化内部类</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> requireExpose;<span class="comment">//需要Expose注解？</span></span><br><span class="line">  <span class="comment">//存放序列化排除策略</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ExclusionStrategy&gt; serializationStrategies = Collections.emptyList();</span><br><span class="line">  <span class="comment">//存放反序列化排除策略</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;ExclusionStrategy&gt; deserializationStrategies = Collections.emptyList();</span><br></pre></td></tr></table></figure>
<p>所有的方法如下:<br><img src="http://static.zybuluo.com/maplejaw/3v7hbglfw3zul8vh4f9wbgcj/image_1amm2a5vkurd1t6ku4412do8om9.png" alt="image_1amm2a5vkurd1t6ku4412do8om9.png-45.5kB"></p>
</li>
<li><p>Primitives 一个工具类，用于在原始类型和包装类型间转化。<code>wrap</code>包装，<code>unwrap</code>解开。</p>
</li>
<li><p>ObjectConstructor 一个人通用的构造器接口。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObjectConstructor</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> T <span class="title">construct</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ConstructorConstructor 保存实例构造器集合的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstructorConstructor</span> </span>&#123;</span><br><span class="line">   <span class="comment">//实例创造器集合</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Type, InstanceCreator&lt;?&gt;&gt; instanceCreators;</span><br><span class="line">   <span class="comment">//通过类型返回一个构造器</span></span><br><span class="line">   </span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">ObjectConstructor&lt;T&gt; <span class="title">get</span><span class="params">(TypeToken&lt;T&gt; typeToken)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">final</span> Type type = typeToken.getType();<span class="comment">//获取类型</span></span><br><span class="line">  <span class="keyword">final</span> Class&lt;? <span class="keyword">super</span> T&gt; rawType = typeToken.getRawType();<span class="comment">//获取真实类型</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//首先从集合中获取看有没有相同的Type，有就创造实例并返回</span></span><br><span class="line">  <span class="keyword">final</span> InstanceCreator&lt;T&gt; typeCreator = (InstanceCreator&lt;T&gt;) instanceCreators.get(type);</span><br><span class="line">  <span class="keyword">if</span> (typeCreator != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectConstructor&lt;T&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> typeCreator.createInstance(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//然后根据原始类型取，去集合中取</span></span><br><span class="line">  <span class="keyword">final</span> InstanceCreator&lt;T&gt; rawTypeCreator =</span><br><span class="line">      (InstanceCreator&lt;T&gt;) instanceCreators.get(rawType);</span><br><span class="line">  <span class="keyword">if</span> (rawTypeCreator != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectConstructor&lt;T&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rawTypeCreator.createInstance(type);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取默认构造方法</span></span><br><span class="line">  ObjectConstructor&lt;T&gt; defaultConstructor = newDefaultConstructor(rawType);</span><br><span class="line">  <span class="keyword">if</span> (defaultConstructor != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> defaultConstructor;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取集合类型的构造器（Collection，EnumSet，Set，Queue，Map）</span></span><br><span class="line">  ObjectConstructor&lt;T&gt; defaultImplementation = newDefaultImplementationConstructor(type, rawType);</span><br><span class="line">  <span class="keyword">if</span> (defaultImplementation != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> defaultImplementation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用不安全的分配器</span></span><br><span class="line">  <span class="keyword">return</span> newUnsafeAllocator(type, rawType);</span><br><span class="line">&#125;</span><br><span class="line">   <span class="comment">//..</span></span><br><span class="line">   <span class="comment">//省略了部分源码</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>JsonStreamParser 解析器，解析为JsonElement。<code>hasNext</code>:是否有下一个元素，<code>next</code>取下一个元素，返回JsonElement。</p>
</li>
<li><p>Streams 内部使用<code>TypeAdapters.JSON_ELEMENT</code>写入/读取下一个JsonElement。</p>
</li>
</ul>
<h3 id="GSON-源码解读"><a href="#GSON-源码解读" class="headerlink" title="GSON 源码解读"></a>GSON 源码解读</h3><h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><p>现在我们从Gson的构造方法入手，解读Gson是如何工作的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">Gson(<span class="keyword">final</span> Excluder excluder, <span class="keyword">final</span> FieldNamingStrategy fieldNamingStrategy,</span><br><span class="line">     <span class="keyword">final</span> Map&lt;Type, InstanceCreator&lt;?&gt;&gt; instanceCreators, <span class="keyword">boolean</span> serializeNulls,</span><br><span class="line">     <span class="keyword">boolean</span> complexMapKeySerialization, <span class="keyword">boolean</span> generateNonExecutableGson, <span class="keyword">boolean</span> htmlSafe,</span><br><span class="line">     <span class="keyword">boolean</span> prettyPrinting, <span class="keyword">boolean</span> lenient, <span class="keyword">boolean</span> serializeSpecialFloatingPointValues,</span><br><span class="line">     LongSerializationPolicy longSerializationPolicy,</span><br><span class="line">     List&lt;TypeAdapterFactory&gt; typeAdapterFactories) &#123;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">   <span class="keyword">this</span>.constructorConstructor = <span class="keyword">new</span> ConstructorConstructor(instanceCreators);<span class="comment">//实例构造器</span></span><br><span class="line">   <span class="keyword">this</span>.excluder = excluder;<span class="comment">//排除器</span></span><br><span class="line">   <span class="keyword">this</span>.fieldNamingStrategy = fieldNamingStrategy;<span class="comment">//字段命名策略</span></span><br><span class="line">   <span class="keyword">this</span>.serializeNulls = serializeNulls;<span class="comment">//序列化空</span></span><br><span class="line">   <span class="keyword">this</span>.generateNonExecutableJson = generateNonExecutableGson;<span class="comment">//生成不可执行前缀（用来防止攻击）</span></span><br><span class="line">   <span class="keyword">this</span>.htmlSafe = htmlSafe;<span class="comment">//html转义</span></span><br><span class="line">   <span class="keyword">this</span>.prettyPrinting = prettyPrinting;<span class="comment">//缩进打印</span></span><br><span class="line">   <span class="keyword">this</span>.lenient = lenient;<span class="comment">//宽松的容错性</span></span><br><span class="line"></span><br><span class="line">   List&lt;TypeAdapterFactory&gt; factories = <span class="keyword">new</span> ArrayList&lt;TypeAdapterFactory&gt;();<span class="comment">//TypeAdapter的工厂列表</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">//以下都是往工厂列表加入TypeAdapterFactory</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 构建不能被重载的TypeAdapter</span></span><br><span class="line">   factories.add(TypeAdapters.JSON_ELEMENT_FACTORY);</span><br><span class="line">   factories.add(ObjectTypeAdapter.FACTORY);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 排除器必须在所有的用于自定义的typeAdapter之前</span></span><br><span class="line">   factories.add(excluder);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//用户自定义的typeAdapter工厂</span></span><br><span class="line">   factories.addAll(typeAdapterFactories);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//以下为默认的TypeAdapter</span></span><br><span class="line">   factories.add(TypeAdapters.STRING_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.INTEGER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.BOOLEAN_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.BYTE_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.SHORT_FACTORY);</span><br><span class="line">   TypeAdapter&lt;Number&gt; longAdapter = longAdapter(longSerializationPolicy);</span><br><span class="line">   factories.add(TypeAdapters.newFactory(<span class="keyword">long</span>.class, Long.class, longAdapter));</span><br><span class="line">   factories.add(TypeAdapters.newFactory(<span class="keyword">double</span>.class, Double.class,</span><br><span class="line">           doubleAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">   factories.add(TypeAdapters.newFactory(<span class="keyword">float</span>.class, Float.class,</span><br><span class="line">           floatAdapter(serializeSpecialFloatingPointValues)));</span><br><span class="line">   factories.add(TypeAdapters.NUMBER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.ATOMIC_INTEGER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.ATOMIC_BOOLEAN_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.newFactory(AtomicLong.class, atomicLongAdapter(longAdapter)));</span><br><span class="line">   factories.add(TypeAdapters.newFactory(AtomicLongArray.class, atomicLongArrayAdapter(longAdapter)));</span><br><span class="line">   factories.add(TypeAdapters.ATOMIC_INTEGER_ARRAY_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.CHARACTER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.STRING_BUILDER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.STRING_BUFFER_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.newFactory(BigDecimal.class, TypeAdapters.BIG_DECIMAL));</span><br><span class="line">   factories.add(TypeAdapters.newFactory(BigInteger.class, TypeAdapters.BIG_INTEGER));</span><br><span class="line">   factories.add(TypeAdapters.URL_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.URI_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.UUID_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.CURRENCY_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.LOCALE_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.INET_ADDRESS_FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.BIT_SET_FACTORY);</span><br><span class="line">   factories.add(DateTypeAdapter.FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.CALENDAR_FACTORY);</span><br><span class="line">   factories.add(TimeTypeAdapter.FACTORY);</span><br><span class="line">   factories.add(SqlDateTypeAdapter.FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.TIMESTAMP_FACTORY);</span><br><span class="line">   factories.add(ArrayTypeAdapter.FACTORY);</span><br><span class="line">   factories.add(TypeAdapters.CLASS_FACTORY);</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//复合的TypeAdapter</span></span><br><span class="line">   factories.add(<span class="keyword">new</span> CollectionTypeAdapterFactory(constructorConstructor));</span><br><span class="line">   factories.add(<span class="keyword">new</span> MapTypeAdapterFactory(constructorConstructor, complexMapKeySerialization));</span><br><span class="line">   <span class="keyword">this</span>.jsonAdapterFactory = <span class="keyword">new</span> JsonAdapterAnnotationTypeAdapterFactory(constructorConstructor);</span><br><span class="line">   factories.add(jsonAdapterFactory);</span><br><span class="line">   factories.add(TypeAdapters.ENUM_FACTORY);</span><br><span class="line">   factories.add(<span class="keyword">new</span> ReflectiveTypeAdapterFactory(</span><br><span class="line">       constructorConstructor, fieldNamingStrategy, excluder, jsonAdapterFactory));</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.factories = Collections.unmodifiableList(factories);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>构造方法让人看的眼花缭乱，尤其是往集合中加入了那么多的TypeAdapterFactory。由于是在太多无法逐一介绍。就挑个最简单的来讲解。总之明白TypeAdapter的作用即可。<br>ObjectTypeAdapter：内部有一个静态工厂类，所以只需<code>ObjectTypeAdapter.FACTORY</code>这样调用即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectTypeAdapter</span> <span class="keyword">extends</span> <span class="title">TypeAdapter</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">//工厂类</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> TypeAdapterFactory FACTORY = <span class="keyword">new</span> TypeAdapterFactory() &#123;</span><br><span class="line">    <span class="comment">//该工厂用来创建Object类型的TypeAdapter</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">create</span><span class="params">(Gson gson, TypeToken&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (type.getRawType() == Object.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> (TypeAdapter&lt;T&gt;) <span class="keyword">new</span> ObjectTypeAdapter(gson);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>接口的实现方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取</span></span><br><span class="line"> <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(JsonReader in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JsonToken token = in.peek();<span class="comment">//查看元素类型</span></span><br><span class="line">    <span class="keyword">switch</span> (token) &#123;</span><br><span class="line">    <span class="keyword">case</span> BEGIN_ARRAY:<span class="comment">//数组</span></span><br><span class="line">      List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line">      in.beginArray();<span class="comment">//开始标识</span></span><br><span class="line">      <span class="keyword">while</span> (in.hasNext()) &#123;<span class="comment">//还有下一个元素？</span></span><br><span class="line">        list.add(read(in));</span><br><span class="line">      &#125;</span><br><span class="line">      in.endArray();<span class="comment">//结束标识</span></span><br><span class="line">      <span class="keyword">return</span> list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BEGIN_OBJECT:<span class="comment">//对象</span></span><br><span class="line">      Map&lt;String, Object&gt; map = <span class="keyword">new</span> LinkedTreeMap&lt;String, Object&gt;();</span><br><span class="line">      in.beginObject();</span><br><span class="line">      <span class="keyword">while</span> (in.hasNext()) &#123;</span><br><span class="line">        map.put(in.nextName(), read(in));</span><br><span class="line">      &#125;</span><br><span class="line">      in.endObject();</span><br><span class="line">      <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> STRING:</span><br><span class="line">      <span class="keyword">return</span> in.nextString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NUMBER:</span><br><span class="line">      <span class="keyword">return</span> in.nextDouble();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">      <span class="keyword">return</span> in.nextBoolean();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NULL:</span><br><span class="line">      in.nextNull();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//写为json</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(JsonWriter out, Object value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">      out.nullValue();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//gson.getAdapter获取对应类型的TypeAdapter</span></span><br><span class="line">    TypeAdapter&lt;Object&gt; typeAdapter = (TypeAdapter&lt;Object&gt;) gson.getAdapter(value.getClass());</span><br><span class="line">    <span class="keyword">if</span> (typeAdapter <span class="keyword">instanceof</span> ObjectTypeAdapter) &#123;</span><br><span class="line">      out.beginObject();</span><br><span class="line">      out.endObject();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    typeAdapter.write(out, value);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>关于TypeAdapter这里就不继续深究了，预定义的TypeAdapter实在太多了。其中<code>JsonAdapterAnnotationTypeAdapterFactory</code>用来处理<code>@JsonAdapter</code>注解,<code>ReflectiveTypeAdapterFactory</code>用来反射获取字段等等。</p>
<h4 id="getAdapter"><a href="#getAdapter" class="headerlink" title="getAdapter"></a>getAdapter</h4><p>将Java对象序列化为Json字符串时，需要调用<code>gson.getAdapter(XX)</code>来获取相应类型的转换器，然后按照TypeAdapter中规定好的规则进行序列化/反序列化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">TypeAdapter&lt;T&gt; <span class="title">getAdapter</span><span class="params">(TypeToken&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//从typeTokenCache的Map中取出</span></span><br><span class="line">   <span class="comment">//NULL_KEY_SURROGATE表示Object类型</span></span><br><span class="line">   TypeAdapter&lt;?&gt; cached = typeTokenCache.get(type == <span class="keyword">null</span> ? NULL_KEY_SURROGATE : type);</span><br><span class="line">   <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> (TypeAdapter&lt;T&gt;) cached;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//threadCalls是一个中间线程变量</span></span><br><span class="line">   Map&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt; threadCalls = calls.get();</span><br><span class="line">   <span class="keyword">boolean</span> requiresThreadLocalCleanup = <span class="keyword">false</span>;</span><br><span class="line">   <span class="keyword">if</span> (threadCalls == <span class="keyword">null</span>) &#123;</span><br><span class="line">     threadCalls = <span class="keyword">new</span> HashMap&lt;TypeToken&lt;?&gt;, FutureTypeAdapter&lt;?&gt;&gt;();</span><br><span class="line">     calls.set(threadCalls);</span><br><span class="line">     requiresThreadLocalCleanup = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取回FutureTypeAdapter，FutureTypeAdapter是一个代理TypeAdapter</span></span><br><span class="line">   FutureTypeAdapter&lt;T&gt; ongoingCall = (FutureTypeAdapter&lt;T&gt;) threadCalls.get(type);</span><br><span class="line">   <span class="keyword">if</span> (ongoingCall != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> ongoingCall;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">//new FutureTypeAdapter</span></span><br><span class="line">     FutureTypeAdapter&lt;T&gt; call = <span class="keyword">new</span> FutureTypeAdapter&lt;T&gt;();</span><br><span class="line">     threadCalls.put(type, call);<span class="comment">//放入线程变量中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//从工厂中遍历，加入typeTokenCache</span></span><br><span class="line">     <span class="keyword">for</span> (TypeAdapterFactory factory : factories) &#123;</span><br><span class="line">       TypeAdapter&lt;T&gt; candidate = factory.create(<span class="keyword">this</span>, type);<span class="comment">//create创造实例</span></span><br><span class="line">       <span class="keyword">if</span> (candidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">         call.setDelegate(candidate);</span><br><span class="line">         typeTokenCache.put(type, candidate);</span><br><span class="line">         <span class="keyword">return</span> candidate;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"GSON cannot handle "</span> + type);</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     threadCalls.remove(type);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (requiresThreadLocalCleanup) &#123;</span><br><span class="line">       calls.remove();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>以上源码的流程是这样的。首先从<code>typeTokenCache</code>中获取看看有没有相应类型的Adapter，第一次肯定没有，然后利用中间变量<code>FutureTypeAdapter</code>,从工厂中遍历去取，然后放入<code>typeTokenCache</code>中。<code>FutureTypeAdapter</code>是一个代理TypeAdapter,内部还是原TypeAdapter进行处理。</p>
<h4 id="toJson"><a href="#toJson" class="headerlink" title="toJson"></a>toJson</h4><p>终于快接近尾声了，现在来看<code>toJson</code>方法的内部原理，到底是怎么一步步将对象转为Json字符串的。最终调用的是<code>toJson(Object src, Type typeOfSrc, JsonWriter writer)</code>方法，通过相应的Adapter进行读写。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//传入一个Object</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toJson</span><span class="params">(Object src)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (src == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> toJson(JsonNull.INSTANCE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toJson(src, src.getClass());<span class="comment">//重载调用</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//重载方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc)</span> </span>&#123;</span><br><span class="line">    StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    toJson(src, typeOfSrc, writer);</span><br><span class="line">    <span class="keyword">return</span> writer.toString();<span class="comment">//返回String</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//将StringWriter转为JsonWriter。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc, Appendable writer)</span> <span class="keyword">throws</span> JsonIOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      JsonWriter jsonWriter = newJsonWriter(Streams.writerForAppendable(writer));<span class="comment">//转为JsonWriter。</span></span><br><span class="line">      toJson(src, typeOfSrc, jsonWriter);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toJson</span><span class="params">(Object src, Type typeOfSrc, JsonWriter writer)</span> <span class="keyword">throws</span> JsonIOException </span>&#123;</span><br><span class="line">    <span class="comment">//调用getAdapter获取相应类型的TypeAdapter。</span></span><br><span class="line">    TypeAdapter&lt;?&gt; adapter = getAdapter(TypeToken.get(typeOfSrc));</span><br><span class="line">    <span class="comment">//设置配置</span></span><br><span class="line">    <span class="keyword">boolean</span> oldLenient = writer.isLenient();</span><br><span class="line">    writer.setLenient(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">boolean</span> oldHtmlSafe = writer.isHtmlSafe();</span><br><span class="line">    writer.setHtmlSafe(htmlSafe);</span><br><span class="line">    <span class="keyword">boolean</span> oldSerializeNulls = writer.getSerializeNulls();</span><br><span class="line">    writer.setSerializeNulls(serializeNulls);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//调用adapter的write方法</span></span><br><span class="line">      ((TypeAdapter&lt;Object&gt;) adapter).write(writer, src);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JsonIOException(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      writer.setLenient(oldLenient);</span><br><span class="line">      writer.setHtmlSafe(oldHtmlSafe);</span><br><span class="line">      writer.setSerializeNulls(oldSerializeNulls);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="fromJson"><a href="#fromJson" class="headerlink" title="fromJson"></a>fromJson</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//传入一个json字符串和一个转换类型。</span></span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String json, Class&lt;T&gt; classOfT)</span> <span class="keyword">throws</span> JsonSyntaxException </span>&#123;</span><br><span class="line">   Object object = fromJson(json, (Type) classOfT);<span class="comment">//调用重载</span></span><br><span class="line">   <span class="keyword">return</span> Primitives.wrap(classOfT).cast(object);<span class="comment">//如果是基本数据类型还会被包装返回（即 int =&gt; Integer）</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重载方法 </span></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(String json, Type typeOfT)</span> <span class="keyword">throws</span> JsonSyntaxException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (json == <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   StringReader reader = <span class="keyword">new</span> StringReader(json)；<span class="comment">//使用StringReader包装</span></span><br><span class="line">   T target = (T) fromJson(reader, typeOfT);</span><br><span class="line">   <span class="keyword">return</span> target;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//重载方法，将StringReader转为JsonReader</span></span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(Reader json, Type typeOfT)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">   JsonReader jsonReader = newJsonReader(json);</span><br><span class="line">   T object = (T) fromJson(jsonReader, typeOfT);</span><br><span class="line">   assertFullConsumption(object, jsonReader);<span class="comment">//判断是不是读完了</span></span><br><span class="line">   <span class="keyword">return</span> object;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//最终方法</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">fromJson</span><span class="params">(JsonReader reader, Type typeOfT)</span> <span class="keyword">throws</span> JsonIOException, JsonSyntaxException </span>&#123;</span><br><span class="line">   <span class="keyword">boolean</span> isEmpty = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">boolean</span> oldLenient = reader.isLenient();</span><br><span class="line">   reader.setLenient(<span class="keyword">true</span>);</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     reader.peek();</span><br><span class="line">     isEmpty = <span class="keyword">false</span>;</span><br><span class="line">     <span class="comment">//转为TypeToken</span></span><br><span class="line">     TypeToken&lt;T&gt; typeToken = (TypeToken&lt;T&gt;) TypeToken.get(typeOfT);</span><br><span class="line">     <span class="comment">//获取TypeAdapter</span></span><br><span class="line">     TypeAdapter&lt;T&gt; typeAdapter = getAdapter(typeToken);</span><br><span class="line">     <span class="comment">//调用TypeAdapter的read</span></span><br><span class="line">     T object = typeAdapter.read(reader);</span><br><span class="line">     <span class="keyword">return</span> object;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (EOFException e) &#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">    <span class="comment">//省略部分源码</span></span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     reader.setLenient(oldLenient);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="GsonBuilder"><a href="#GsonBuilder" class="headerlink" title="GsonBuilder"></a>GsonBuilder</h3><p>GsonBuilder用来对Gson进行配置，比如注册TypeAdapter等等。最后调用<code>create()</code>返回Gson对象。</p>
<p><img src="http://static.zybuluo.com/maplejaw/3lgovuh2y7o7cd94tuxwrvzr/image_1amn76ilalcs2usk3t1mjddmm9.png" alt="image_1amn76ilalcs2usk3t1mjddmm9.png-55.7kB"></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>Gson内部的Json与Java间的转换依赖于各类的TypeAdapter，通过registerTypeAdapter可以注册新的类型转换器，实例创造器的等。越先注册的优先级就越高。当然，如果你没有注册Adapter，对于自定义的对象一般参与转换的Adapter是<code>ReflectiveTypeAdapterFactory</code>。有兴趣的请自行阅读源码。<br>registerTypeAdapter的源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> GsonBuilder <span class="title">registerTypeAdapter</span><span class="params">(Type type, Object typeAdapter)</span> </span>&#123;</span><br><span class="line"> <span class="comment">//校验参数</span></span><br><span class="line">  $Gson$Preconditions.checkArgument(typeAdapter <span class="keyword">instanceof</span> JsonSerializer&lt;?&gt;</span><br><span class="line">      || typeAdapter <span class="keyword">instanceof</span> JsonDeserializer&lt;?&gt;</span><br><span class="line">      || typeAdapter <span class="keyword">instanceof</span> InstanceCreator&lt;?&gt;</span><br><span class="line">      || typeAdapter <span class="keyword">instanceof</span> TypeAdapter&lt;?&gt;);</span><br><span class="line">   <span class="comment">//实例构造器   </span></span><br><span class="line">  <span class="keyword">if</span> (typeAdapter <span class="keyword">instanceof</span> InstanceCreator&lt;?&gt;) &#123;</span><br><span class="line">    instanceCreators.put(type, (InstanceCreator) typeAdapter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//序列化/反序列化</span></span><br><span class="line">  <span class="keyword">if</span> (typeAdapter <span class="keyword">instanceof</span> JsonSerializer&lt;?&gt; || typeAdapter <span class="keyword">instanceof</span> JsonDeserializer&lt;?&gt;) &#123;</span><br><span class="line">    TypeToken&lt;?&gt; typeToken = TypeToken.get(type);</span><br><span class="line">    factories.add(TreeTypeAdapter.newFactoryWithMatchRawType(typeToken, typeAdapter));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//TypeAdapter</span></span><br><span class="line">  <span class="keyword">if</span> (typeAdapter <span class="keyword">instanceof</span> TypeAdapter&lt;?&gt;) &#123;</span><br><span class="line">    factories.add(TypeAdapters.newFactory(TypeToken.get(type), (TypeAdapter)typeAdapter));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>本期解读到此结束，由于篇幅问题，Gson中预定义的TypeAdapter实在太多就不进行分析了。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/04/Python3-学习手册（二）-流程控制语句/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Python3 学习手册（二） 流程控制语句
        
      </div>
    </a>
  
  
    <a href="/2016/06/27/PhotoView-源码解读/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">PhotoView 源码解读</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Gson-源码解读" data-title="Gson 源码解读" data-url="http://www.maplejaw.com/2016/07/03/Gson-源码解读/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"maplejaw"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 maplejaw
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>