<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Retrofit2 源码解读 | maplejaw的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="基本概念Retrofit 是一个针对Java/Android类型安全的Http请求客户端。基本使用如下：

首先定义一个接口，抽象方法的返回值必须为Call&amp;lt;XX&amp;gt;。
1234public interface GitHubService &amp;#123;  @GET(&quot;users/&amp;#123;user&amp;#125;/repos&quot;)   Call&amp;lt;List&amp;lt;Repo&amp;gt;&amp;gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="Retrofit2 源码解读">
<meta property="og:url" content="http://www.maplejaw.com/2016/07/22/Retrofit2-源码解读/index.html">
<meta property="og:site_name" content="maplejaw的技术博客">
<meta property="og:description" content="基本概念Retrofit 是一个针对Java/Android类型安全的Http请求客户端。基本使用如下：

首先定义一个接口，抽象方法的返回值必须为Call&amp;lt;XX&amp;gt;。
1234public interface GitHubService &amp;#123;  @GET(&quot;users/&amp;#123;user&amp;#125;/repos&quot;)   Call&amp;lt;List&amp;lt;Repo&amp;gt;&amp;gt;">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/xg10m9qzfz5k9wa8g1qzxntm/image_1ank3mstmho91qum9k646415a29.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/jca4h51go0h6hcpywy1u0n18/image_1ank6t5fdqe51k5jm221ff116jjm.png">
<meta property="og:image" content="http://static.zybuluo.com/maplejaw/a2piofnwbxh2p8614jftsbld/image_1ank9trh8mavpd16n1l85nm513.png">
<meta property="og:updated_time" content="2016-07-22T13:23:27.605Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Retrofit2 源码解读">
<meta name="twitter:description" content="基本概念Retrofit 是一个针对Java/Android类型安全的Http请求客户端。基本使用如下：

首先定义一个接口，抽象方法的返回值必须为Call&amp;lt;XX&amp;gt;。
1234public interface GitHubService &amp;#123;  @GET(&quot;users/&amp;#123;user&amp;#125;/repos&quot;)   Call&amp;lt;List&amp;lt;Repo&amp;gt;&amp;gt;">
<meta name="twitter:image" content="http://static.zybuluo.com/maplejaw/xg10m9qzfz5k9wa8g1qzxntm/image_1ank3mstmho91qum9k646415a29.png">
  
    <link rel="alternative" href="/atom.xml" title="maplejaw的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">maplejaw</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不忘初心，方得始终</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">归档</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/开源库/" style="font-size: 10px;">开源库</a> <a href="/tags/插件化探索/" style="font-size: 16px;">插件化探索</a> <a href="/tags/源码解读/" style="font-size: 18px;">源码解读</a> <a href="/tags/知识整理/" style="font-size: 12px;">知识整理</a> <a href="/tags/自定义View/" style="font-size: 10px;">自定义View</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">maplejaw</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="/uploads/avatar.jpeg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">maplejaw</h1>
			</hgroup>
			
			<p class="header-subtitle">不忘初心，方得始终</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">归档</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/maplejaw" title="github">github</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Retrofit2-源码解读" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/22/Retrofit2-源码解读/" class="article-date">
  	<time datetime="2016-07-22T12:55:59.000Z" itemprop="datePublished">2016-07-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Retrofit2 源码解读
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码解读/">源码解读</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>Retrofit 是一个针对Java/Android类型安全的Http请求客户端。<br>基本使用如下：</p>
<ol>
<li><p>首先定义一个接口，抽象方法的返回值必须为<code>Call&lt;XX&gt;</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@GET</span>(<span class="string">"users/&#123;user&#125;/repos"</span>)</span><br><span class="line">   Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path</span>(<span class="string">"user"</span>) String user);<span class="comment">//默认CallAdapter返回值必须为`Call&lt;XX&gt;`。</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过Retrofit的<code>create</code>创建接口实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//初始化Retrofit</span></span><br><span class="line"> Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line"> .baseUrl(<span class="string">"https://api.github.com/"</span>) <span class="comment">//必须以斜杠结尾</span></span><br><span class="line"> .addConverterFactory(GsonConverterFactory.create())<span class="comment">//添加Gson转换工厂</span></span><br><span class="line"> .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过Retrofit创建接口实现</span></span><br><span class="line">GitHubService service = retrofit.create(GitHubService.class);</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口调用相关方法获取<code>Call&lt;XX&gt;</code>,然后就能和Okhttp一样进行同步/异步调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</span><br><span class="line"><span class="comment">//异步调用</span></span><br><span class="line">repos.enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Repo&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Response&lt;List&lt;Repo&gt;&gt; response)</span> </span>&#123;</span><br><span class="line">                 List&lt;String&gt; list=response.body();<span class="comment">//调用body()</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Repo&gt;&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> <span class="comment">//同步调用</span></span><br><span class="line">  Response&lt;List&lt;Repo&gt;&gt; response=repos.execute();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><h3 id="Retrofit中的相关注解"><a href="#Retrofit中的相关注解" class="headerlink" title="Retrofit中的相关注解"></a>Retrofit中的相关注解</h3><h4 id="请求方法注解"><a href="#请求方法注解" class="headerlink" title="请求方法注解"></a>请求方法注解</h4><p>该类注解用于指明请求方法，在使用时必须指定且只可指定一种请求方法。</p>
<ol>
<li><p>@GET</p>
<p> 用来指明请求方法和相对/绝对/完整路径。当然也可以配合@Url使用。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"xx/xxx"</span>) <span class="comment">//指定相对路径</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent1</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"/xxx"</span>) <span class="comment">//指定绝对路径，相对路径和绝对路径的区别见后文</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent1</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"http://www.baidu.com"</span>) <span class="comment">//指定完整Url</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent2</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@GET</span> <span class="comment">//配合@Url使用，此时@GET只能指明请求方法，路径参数必须留空</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent3</span><span class="params">(@Url String url)</span></span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@POST</p>
<p>用来指明请求方法和相对/绝对/完整路径，同时也可以配合@Url使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@POST</span>(<span class="string">"xx/xxx"</span>) <span class="comment">//指定相对路径</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent1</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="meta">@POST</span>(<span class="string">"/xxx"</span>) <span class="comment">//指定绝对路径</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent1</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="meta">@POST</span>(<span class="string">"http://www.baidu.com"</span>) <span class="comment">//指定完整Url</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent2</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@POST</span> <span class="comment">//配合@Url使用，此时@POST只能指明请求方法，路径参数必须留空</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent3</span><span class="params">(@Url String url)</span></span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@DELETE,@HEAD,@OPTIONS,@PATCH,@PUT</p>
<p>这几种请求方法和POST/GET在使用上没有太大区别，由于不太常用，这里就不做介绍。</p>
</li>
</ol>
<h4 id="请求参数注解"><a href="#请求参数注解" class="headerlink" title="请求参数注解"></a>请求参数注解</h4><ol>
<li><p>@Path<br> 该注解用于替换Url的路径(path)部分。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"/image/&#123;id&#125;"</span>) <span class="comment">//替换&#123;&#125;内的路径</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getImage</span><span class="params">(@Path(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"/user/&#123;name&#125;"</span>) <span class="comment">//替换&#123;&#125;内的路径</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getUserInfo</span><span class="params">(@Path(<span class="string">"name"</span>)</span> String name)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"/user/&#123;name&#125;"</span>) <span class="comment">//替换&#123;&#125;内的路径，encoded=true则表示自己处理编码，</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getUserInfo</span><span class="params">(@Path(value=<span class="string">"name"</span>, encoded=<span class="keyword">true</span>)</span> String name)</span>;</span><br><span class="line">   </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 上述代码有一个是否需要编码的问题，这里举个例子：假如输入名字<code>maple+jaw</code>,默认情况下为GET中的注解为<code>/user/maple%2Bjaw</code>,如果指明自己处理编码，此时输入<code>maple+jaw</code>，路径参数为<code>/user/maple+jaw</code></p>
</li>
<li><p>@Query<br>该注解用于在Url后追加查询参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/list"</span>) <span class="comment">//追加查询参数后，此时路径为/list?page=xx</span></span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getList</span><span class="params">(@Query(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/list"</span>) <span class="comment">//追加查询参数后，此时路径为/list?page=xx&amp;category=xx</span></span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getList</span><span class="params">(@Query(<span class="string">"page"</span>)</span> <span class="keyword">int</span> page,@<span class="title">Query</span><span class="params">(<span class="string">"category"</span>)</span> String category)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/list"</span>) <span class="comment">//同理也可指定是否编码</span></span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getList</span><span class="params">(@Query(value=<span class="string">"category"</span>,encoded=<span class="keyword">true</span>)</span> String category)</span>;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@QueryMap<br>@QueryMap和@Query的作用是一样的，只不过@QueryMap是以map的形式追加参数,可以一次性追加多个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@GET</span>(<span class="string">"/search"</span>) </span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">getList</span><span class="params">(@QueryMap Map&lt;String, String&gt; filters)</span></span>;</span><br><span class="line">   </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Field<br>该注解用于添加表单数据，须配合<code>@FormUrlEncoded</code>一起使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@FormUrlEncoded</span></span><br><span class="line">   <span class="meta">@POST</span>(<span class="string">"/register"</span>) <span class="comment">//使用@Field提交表单数据</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">register</span><span class="params">(@Field(<span class="string">"name"</span>)</span> String name,@<span class="title">Field</span><span class="params">(<span class="string">"password"</span>)</span> String pwd,)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="meta">@FormUrlEncoded</span></span><br><span class="line">   <span class="meta">@POST</span>(<span class="string">"/register"</span>) <span class="comment">//使用@Field提交表单数据,encoded=true表示该数据自己编码</span></span><br><span class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">register</span><span class="params">(@Field(value=<span class="string">"name"</span>,encoded=<span class="keyword">true</span>)</span> String name,@<span class="title">Field</span><span class="params">(<span class="string">"password"</span>)</span> String pwd,)</span>;</span><br><span class="line">   </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@FieldMap<br>@Field和@FieldMap的作用一样，后者以map的方式提交表单数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST</span>(<span class="string">"/register"</span>) <span class="comment">//使用@FieldMap提交表单数据</span></span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">register</span><span class="params">(@FieldMap Map&lt;String, String&gt; fields)</span></span>;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Header<br>该注解用于指明请求头参数，相同名字的请求头是惟一的,新的会直接覆盖旧的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/"</span>) </span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent</span><span class="params">(@Header(<span class="string">"Accept-Language"</span>)</span> String lang</span><br><span class="line">                                 ,@<span class="title">Header</span><span class="params">(<span class="string">"Cache-Control"</span>)</span> String cache)</span>;        </span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Headers<br>该注解用于指明请求头参数，和@Header的区别在于不会覆盖掉相同名字的请求参数</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Headers</span>(<span class="string">"Cache-Control: max-age=640000"</span>)</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/"</span>) </span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent</span><span class="params">()</span></span>;   </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Headers</span>(&#123;<span class="string">"Cache-Control: max-age=640000"</span>，<span class="string">"Accept-Language: gzip, deflate"</span>&#125;)</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/"</span>) </span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getContent</span><span class="params">()</span></span>;  </span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@HeaderMap<br> @HeaderMap和@Headers的作用一样，区别在于以Map的形式指明请求头参数。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/search"</span>) </span><br><span class="line">    <span class="function">Call&lt;ResponseBody&gt; <span class="title">getList</span><span class="params">(@HeaderMap Map&lt;String, String&gt; headers)</span></span>;       </span><br><span class="line"> </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Part<br> 该注解用于定义分块表单请求中的块。需配合@Multipart一起使用。<br> 如果类型是MultipartBody.Part，内容将直接被使用。（<code>@Part MultipartBody.Part part</code>）<br> 如果类型是RequestBody,将会和它的contentType一起使用。（<code>@Part(&quot;foo&quot;) RequestBody foo</code>）<br> 其他类型将会通过转换器转换后使用。（<code>@Part(&quot;foo&quot;) Image photo</code>）<br> @Part(XX),XX表示表单名。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Multipart</span></span><br><span class="line">  <span class="meta">@POST</span>(<span class="string">"/"</span>) </span><br><span class="line">  <span class="function">Call&lt;ResponseBody&gt; <span class="title">example</span><span class="params">(@Part(<span class="string">"description"</span>)</span> String description,</span><br><span class="line">                          @<span class="title">Part</span><span class="params">(value = <span class="string">"image"</span>, encoding = <span class="string">"8-bit"</span>)</span> RequestBody image)</span>;       </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@PartMap<br>和@Part的作用一样，区别在于以Map的形式定义,其中Map的Value类型转换同@Part。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Multipart</span></span><br><span class="line">  <span class="meta">@POST</span>(<span class="string">"/upload"</span>) </span><br><span class="line">  <span class="function">Call&lt;ResponseBody&gt; <span class="title">example</span><span class="params">(@Part(<span class="string">"file\"; filename=\"test.txt"</span>)</span> RequestBody file,</span><br><span class="line">                          @PartMap Map&lt;String, RequestBody&gt; params)</span>;       </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Body<br>当请求体不是表单/分块类型时，该注解用于直接指定请求体。请求体内部转换时通过<code>Converter</code>转换为<code>RequestBody</code>实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@POST</span>(<span class="string">"/upload"</span>) </span><br><span class="line">  <span class="function">Call&lt;ResponseBody&gt; <span class="title">example</span><span class="params">(@Body String conent)</span></span>;       </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@HTTP<br>该注解用于自定义请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="meta">@HTTP</span>(method = <span class="string">"DELETE"</span>, path = <span class="string">"remove/"</span>, hasBody = <span class="keyword">true</span>)</span><br><span class="line">  <span class="function">Call&lt;ResponseBody&gt; <span class="title">deleteObject</span><span class="params">(@Body RequestBody object)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@HTTP</span>(method = <span class="string">"CUSTOM"</span>, path = <span class="string">"custom/endpoint/"</span>)</span><br><span class="line"> <span class="function">Call&lt;ResponseBody&gt; <span class="title">customEndpoint</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@Streaming<br>使用该注解后，将不会缓冲流到内存中，只在返回类型为<code>Call&lt;ResponseBody&gt;</code>时起效。如果使用Retrofit下载大文件，务必要加上该注解。</p>
</li>
</ol>
<h3 id="Retrofit构造"><a href="#Retrofit构造" class="headerlink" title="Retrofit构造"></a>Retrofit构造</h3><p>按照老规矩，从Retrofit的构造方法下手，要想了解Retrofit的构造方法，必须先了解以下几个类</p>
<h4 id="Call接口"><a href="#Call接口" class="headerlink" title="Call接口"></a>Call接口</h4><p>注意，此Call非Okhttp中的Call，结构如下，通过Call可以进行同步和异步请求，还能判断取消与否。<br><img src="http://static.zybuluo.com/maplejaw/xg10m9qzfz5k9wa8g1qzxntm/image_1ank3mstmho91qum9k646415a29.png" alt="image_1ank3mstmho91qum9k646415a29.png-20.2kB"></p>
<h4 id="CallAdapter"><a href="#CallAdapter" class="headerlink" title="CallAdapter"></a>CallAdapter</h4><p>CallAdapter主要用来代理call（默认为OkhttpCall）以方便实现自己想要的功能,比如<code>RxJavaCallAdapter</code>等。可以通过<code>Retrofit.Builder#addCallAdapterFactory(Factory)</code>来添加CallAdapterFactory。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CallAdapter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//返回响应类型，即Call&lt;Repo&gt;的响应类型为Repo</span></span><br><span class="line">  <span class="function">Type <span class="title">responseType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//返回一个代理call的实例。</span></span><br><span class="line">  &lt;R&gt; <span class="function">T <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span></span>;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了工厂源码，用于获取CallAdapter的实例</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a>Callback</h4><p>Callback用于回调结果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//接收HTTP响应（404,500也会调用，所以需要调用isSuccessful来判断） </span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, Response&lt;T&gt; response)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//网络异常或者发生异常时调用</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, Throwable t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h4><p>用于类型转换，使用<code>Retrofit.Builder#addConverterFactory(Factory)</code>添加转换工厂，比如添加Gson转换。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Converter</span>&lt;<span class="title">F</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">T <span class="title">convert</span><span class="params">(F value)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了工厂源码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><p>Retrofit构造方法采用构建者模式构造，源码如下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, ServiceMethod&gt; serviceMethodCache = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();<span class="comment">//key为接口中定义方法，value为转换过后的方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Platform platform;<span class="comment">//平台：安卓、java等</span></span><br><span class="line">  <span class="keyword">private</span> okhttp3.Call.Factory callFactory; <span class="comment">//okhttp的Call工厂类,自定义newCall将Request转为Call</span></span><br><span class="line">  <span class="keyword">private</span> HttpUrl baseUrl;<span class="comment">//okhttp中的类，保存解析过的url</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">//类型转换工厂列表。</span></span><br><span class="line">  <span class="keyword">private</span> List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">//CallAdapter工厂列表。</span></span><br><span class="line">  <span class="keyword">private</span> Executor callbackExecutor;<span class="comment">//回调线程池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> validateEagerly;<span class="comment">//急需验证？作用在于直接将所有方法加入前面的map缓存中。</span></span><br><span class="line"></span><br><span class="line">  Builder(Platform platform) &#123;</span><br><span class="line">    <span class="keyword">this</span>.platform = platform;</span><br><span class="line">    converterFactories.add(<span class="keyword">new</span> BuiltInConverters());<span class="comment">//添加默认的转换器</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Platform.get());<span class="comment">//通过Platform.get()获取关于当前平台的实现</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base URL required."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</span><br><span class="line">    <span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      callFactory = <span class="keyword">new</span> OkHttpClient();<span class="comment">//默认使用OkHttpClient</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</span><br><span class="line">    <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;<span class="comment">//默认使用平台默认回调线程池</span></span><br><span class="line">      callbackExecutor = platform.defaultCallbackExecutor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将平台默认CallAdapter.Factory加入列表中</span></span><br><span class="line">    List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</span><br><span class="line">    adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//将默认Converter.Factory加入列表中</span></span><br><span class="line">    List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.converterFactories);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</span><br><span class="line">        callbackExecutor, validateEagerly);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，首选通过<code>Platform.get()</code>来获取平台实现然后添加了默认转换工厂。由于我们是Android平台，毋容置疑，接下来就去看看Andoird类的源码。<br><img src="http://static.zybuluo.com/maplejaw/jca4h51go0h6hcpywy1u0n18/image_1ank6t5fdqe51k5jm221ff116jjm.png" alt="image_1ank6t5fdqe51k5jm221ff116jjm.png-56.6kB"><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Android</span> <span class="keyword">extends</span> <span class="title">Platform</span> </span>&#123;</span><br><span class="line">  <span class="comment">//回调线程池</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Executor <span class="title">defaultCallbackExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MainThreadExecutor();<span class="comment">//主线程</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> CallAdapter.<span class="function">Factory <span class="title">defaultCallAdapterFactory</span><span class="params">(Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ExecutorCallAdapterFactory继承CallAdapter.Factory,内部代理了原来的Call&lt;T&gt;，用于将Callback回调到指定线程中。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallAdapterFactory(callbackExecutor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThreadExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">      handler.post(r);<span class="comment">//采用Hanlder#post回调到主线程</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Andoird类的源码主要实现了两个方法，一个是实现了默认的回调线程池，用于在主线程中执行任务，另一个是实现了CallAdapter工厂，通过代理的方式，将执行结果回调到callbackExecutor中去执行。所以，我们只需将callbackExecutor赋值为MainThreadExecutor即可实现主线程间的回调。</p>
<p>BuiltInConverters继承于Converter.Factory，Converter.Factory中有三个方法：</p>
<ul>
<li><code>public Converter&lt;ResponseBody, ?&gt; responseBodyConverter（xx）</code>用于将ResponseBody转换为指定类型，通常用于对响应结果的类型转换。</li>
<li><code>public Converter&lt;?, RequestBody&gt; requestBodyConverter(xx)</code>用于将指定类型转为RequestBody。一般用于将<code>@Body,@Part,@PartMap</code>转为RequestBody</li>
<li><code>public Converter&lt;?, String&gt; stringConverter</code>用于将指定类型转为String,用于将<code>@Field,@FieldMap,@Path,@Query,@Header</code>等注解的参数类型转为String。</li>
</ul>
<p>BuiltInConverters源码实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</span><br><span class="line">    Retrofit retrofit) &#123;</span><br><span class="line">   <span class="comment">//根据类型进行选择不同的转换器</span></span><br><span class="line">  <span class="keyword">if</span> (type == ResponseBody.class) &#123;<span class="comment">//转换类型为ResponseBody</span></span><br><span class="line">    <span class="keyword">if</span> (Utils.isAnnotationPresent(annotations, Streaming.class)) &#123;</span><br><span class="line">      <span class="keyword">return</span> StreamingResponseBodyConverter.INSTANCE;<span class="comment">//如果使用了Steaming注解，就不缓冲到内存，直接返回OkHttp的ResponseBody。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BufferingResponseBodyConverter.INSTANCE;<span class="comment">//缓冲ResponseBody到内存后返回</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (type == Void.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> VoidResponseBodyConverter.INSTANCE;<span class="comment">//Void就直接关闭ResponseBody</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</span><br><span class="line">    Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</span><br><span class="line">  <span class="keyword">if</span> (RequestBody.class.isAssignableFrom(Utils.getRawType(type))) &#123;<span class="comment">//默认只处理RequestBody相关类型</span></span><br><span class="line">    <span class="keyword">return</span> RequestBodyConverter.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Converter&lt;?, String&gt; stringConverter(Type type, Annotation[] annotations,</span><br><span class="line">    Retrofit retrofit) &#123;</span><br><span class="line">  <span class="keyword">if</span> (type == String.class) &#123;<span class="comment">//默认只处理String类型的转换，说白了就是直接返回</span></span><br><span class="line">    <span class="keyword">return</span> StringConverter.INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//..</span></span><br><span class="line"><span class="comment">//省略了部分源码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>BuiltInConverters源码中最重要的在于<code>responseBodyConverter</code>方法，如果转换类型是ResponseBody且有@Streaming注解，那么将不会缓冲到内存。你可能会疑问两者有什么区别？那么我们想象一种情景——下载大文件。如果下载大文件时将ResponseBody缓冲到内存，OOM那是分分钟的事。</p>
<p>Retrofit提供的用于自定义的方法如下：<br><img src="http://static.zybuluo.com/maplejaw/a2piofnwbxh2p8614jftsbld/image_1ank9trh8mavpd16n1l85nm513.png" alt="image_1ank9trh8mavpd16n1l85nm513.png-27.5kB"></p>
<ul>
<li><code>client(OkHttpClient)</code> 用于自定义客户端</li>
<li><code>callFactory(okhttp3.Call.Factory factory)</code>用于自定义Call工厂,重写newCall将Request转为Call。OkHttpClient就是实现了这个接口。</li>
<li><code>addConverterFactory</code>添加类型转换工厂(Gson转换等)</li>
<li><code>addCallAdapterFactory</code>添加CallAdapter代理工厂，用来代理原始的Call（RxJavaCallAdapter等）。</li>
<li><code>callbackExecutor</code>自定义回调线程池，默认为主线程</li>
<li><code>validateEagerly</code>是否继续验证，是就提前将所有方法转为ServiceMethod放入缓存中，而不是调用一个缓存一个</li>
<li><code>baseUrl</code>用于定义基本链接，必须以”/“结尾</li>
</ul>
<p>假如基本地址为<code>http://example.com/api/</code>,关于baseUrl与注解中路径的拼接问题如下：</p>
<table>
<thead>
<tr>
<th>注解中的路径</th>
<th>最终Url （baseUrl为<a href="http://example.com/api/）" target="_blank" rel="external">http://example.com/api/）</a></th>
</tr>
</thead>
<tbody>
<tr>
<td>foo/bar/</td>
<td><a href="http://example.com/api/foo/bar/" target="_blank" rel="external">http://example.com/api/foo/bar/</a></td>
</tr>
<tr>
<td>/foo/bar/</td>
<td><a href="http://example.com/foo/bar/" target="_blank" rel="external">http://example.com/foo/bar/</a></td>
</tr>
<tr>
<td><a href="https://github.com/square/retrofit/" target="_blank" rel="external">https://github.com/square/retrofit/</a></td>
<td><a href="https://github.com/square/retrofit/" target="_blank" rel="external">https://github.com/square/retrofit/</a></td>
</tr>
<tr>
<td>//github.com/square/retrofit/</td>
<td><a href="http://github.com/square/retrofit/" target="_blank" rel="external">http://github.com/square/retrofit/</a></td>
</tr>
</tbody>
</table>
<h3 id="创建Service接口"><a href="#创建Service接口" class="headerlink" title="创建Service接口"></a>创建Service接口</h3><p>介绍完构造方法后，我们再来看看<code>retrofit.create(XX.class);</code>这个方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</span><br><span class="line">  Utils.validateServiceInterface(service);<span class="comment">//验证接口，接口不能有继承</span></span><br><span class="line">  <span class="keyword">if</span> (validateEagerly) &#123;</span><br><span class="line">    eagerlyValidateMethods(service);<span class="comment">//将所有方法（跳过默认方法）转为ServiceMethod放入map中</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//使用代理</span></span><br><span class="line">  <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</span><br><span class="line">      <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();<span class="comment">//获取平台</span></span><br><span class="line">       </span><br><span class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object... args)</span></span><br><span class="line">            <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">          <span class="comment">//代理调用</span></span><br><span class="line">          <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//JAVA8接口可以定义默认方法</span></span><br><span class="line">          <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//直接看这里</span></span><br><span class="line">          <span class="comment">//将普通的Method转为ServiceMethod</span></span><br><span class="line">          ServiceMethod serviceMethod = loadServiceMethod(method);</span><br><span class="line">          <span class="comment">//将ServiceMethod以及传入的参数值传入OkHttpCall。</span></span><br><span class="line">          OkHttpCall okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</span><br><span class="line">          <span class="comment">//利用callAdapter代理OkHttpCall，默认直接返回。</span></span><br><span class="line">          <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>retrofit.create(XX.class);</code>方法中使用了Java代理，核心在于，首先将普通的Method转为ServiceMethod，然后将ServiceMethod以及传入的参数值传入到OkHttpCall中，最终通过代理OkHttpCall来返回代理Call，默认是直接返回。</p>
<h4 id="ServiceMethod的创建"><a href="#ServiceMethod的创建" class="headerlink" title="ServiceMethod的创建"></a>ServiceMethod的创建</h4><p>接下来，我们来看看是怎样将Method转为ServiceMethod的，源码在<code>loadServiceMethod</code>方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ServiceMethod <span class="title">loadServiceMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">  ServiceMethod result;</span><br><span class="line">  <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</span><br><span class="line">    result = serviceMethodCache.get(method);<span class="comment">//首先从map中取看看是否已经缓存过</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;<span class="comment">//否则构造ServiceMethod。</span></span><br><span class="line">      result = <span class="keyword">new</span> ServiceMethod.Builder(<span class="keyword">this</span>, method).build();</span><br><span class="line">      serviceMethodCache.put(method, result);<span class="comment">//缓存map中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>loadServiceMethod</code>的方法很简陋，直接传入了Method然后<code>build()</code>,那么这个<code>build()</code>又做了什么？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(Retrofit retrofit, Method method)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.retrofit = retrofit;</span><br><span class="line">      <span class="keyword">this</span>.method = method;</span><br><span class="line">      <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();<span class="comment">//赋值方法注解数组</span></span><br><span class="line">      <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();<span class="comment">//赋值参数类型数组</span></span><br><span class="line">      <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations();<span class="comment">//赋值参数注解数组</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      callAdapter = createCallAdapter();<span class="comment">//创建CallAdapter，用来代理Call</span></span><br><span class="line">      responseType = callAdapter.responseType();<span class="comment">//获取返回类型</span></span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      responseConverter = createResponseConverter();<span class="comment">//创建ResponseConverter，用来转换ResponseBody为指定类型</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</span><br><span class="line">        parseMethodAnnotation(annotation);<span class="comment">//遍历解析方法注解</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;<span class="comment">//parameterAnnotationsArray为参数注解数组</span></span><br><span class="line">      parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];<span class="comment">//初始化ParameterHandler，用来处理参数相关</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;<span class="comment">//遍历参数注解数组</span></span><br><span class="line">        Type parameterType = parameterTypes[p];<span class="comment">//获取参数类型</span></span><br><span class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];<span class="comment">//获取参数注解数组</span></span><br><span class="line">         <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//通过注解和参数类型，解析并赋值到parameterHandlers中</span></span><br><span class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>createCallAdapter</code>用于创建CallAdapter。最终的源码在Retrofit类中，从源码可以看出，进行遍历源码，如果查询到就返回。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CallAdapter&lt;?&gt; nextCallAdapter(CallAdapter.Factory skipPast, Type returnType,</span><br><span class="line">    Annotation[] annotations) &#123;</span><br><span class="line">  checkNotNull(returnType, <span class="string">"returnType == null"</span>);</span><br><span class="line">  checkNotNull(annotations, <span class="string">"annotations == null"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> start = adapterFactories.indexOf(skipPast) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = adapterFactories.size(); i &lt; count; i++) &#123;</span><br><span class="line">    <span class="comment">//遍历Adapter集合，查到就返回</span></span><br><span class="line">    CallAdapter&lt;?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> adapter;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了部分源码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同理，<code>createResponseConverter</code>也是。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Converter&lt;ResponseBody, T&gt; <span class="title">nextResponseBodyConverter</span><span class="params">(Converter.Factory skipPast,</span><br><span class="line">    Type type, Annotation[] annotations)</span> </span>&#123;</span><br><span class="line">  checkNotNull(type, <span class="string">"type == null"</span>);</span><br><span class="line">  checkNotNull(annotations, <span class="string">"annotations == null"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> start = converterFactories.indexOf(skipPast) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</span><br><span class="line">    <span class="comment">//遍历调用查询</span></span><br><span class="line">    Converter&lt;ResponseBody, ?&gt; converter =</span><br><span class="line">        converterFactories.get(i).responseBodyConverter(type, annotations, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (Converter&lt;ResponseBody, T&gt;) converter;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了部分源码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>parseMethodAnnotation</code>用于遍历解析方法上的注解，比如请求方法，请求头之类的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseMethodAnnotation</span><span class="params">(Annotation annotation)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//请求方法注解</span></span><br><span class="line">  <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> DELETE) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"DELETE"</span>, ((DELETE) annotation).value(), <span class="keyword">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> GET) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"GET"</span>, ((GET) annotation).value(), <span class="keyword">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HEAD) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"HEAD"</span>, ((HEAD) annotation).value(), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Void.class.equals(responseType)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(<span class="string">"HEAD method must use Void as response type."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PATCH) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"PATCH"</span>, ((PATCH) annotation).value(), <span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> POST) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"POST"</span>, ((POST) annotation).value(), <span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PUT) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"PUT"</span>, ((PUT) annotation).value(), <span class="keyword">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> OPTIONS) &#123;</span><br><span class="line">    parseHttpMethodAndPath(<span class="string">"OPTIONS"</span>, ((OPTIONS) annotation).value(), <span class="keyword">false</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HTTP) &#123;</span><br><span class="line">    <span class="comment">//自定义HTTP请求注解</span></span><br><span class="line">    HTTP http = (HTTP) annotation;</span><br><span class="line">    parseHttpMethodAndPath(http.method(), http.path(), http.hasBody());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> retrofit2.http.Headers) &#123;</span><br><span class="line">    <span class="comment">//请求头注解</span></span><br><span class="line">    String[] headersToParse = ((retrofit2.http.Headers) annotation).value();</span><br><span class="line">    <span class="keyword">if</span> (headersToParse.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(<span class="string">"@Headers annotation is empty."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    headers = parseHeaders(headersToParse);<span class="comment">//解析Header</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Multipart) &#123;</span><br><span class="line">    <span class="comment">//Multipart</span></span><br><span class="line">    <span class="keyword">if</span> (isFormEncoded) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    isMultipart = <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> FormUrlEncoded) &#123;</span><br><span class="line">    <span class="comment">//FormUrlEncoded</span></span><br><span class="line">    <span class="keyword">if</span> (isMultipart) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    isFormEncoded = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面源码可以看出，使用parseHttpMethodAndPath这个方法用于解析请求方法注解和路径参数保存到Set中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseHttpMethodAndPath</span><span class="params">(String httpMethod, String value, <span class="keyword">boolean</span> hasBody)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.httpMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> methodError(<span class="string">"Only one HTTP method is allowed. Found: %s and %s."</span>,</span><br><span class="line">        <span class="keyword">this</span>.httpMethod, httpMethod);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.httpMethod = httpMethod;</span><br><span class="line">  <span class="keyword">this</span>.hasBody = hasBody;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> question = value.indexOf(<span class="string">'?'</span>);<span class="comment">//查询参数开始的符号</span></span><br><span class="line">  <span class="keyword">if</span> (question != -<span class="number">1</span> &amp;&amp; question &lt; value.length() - <span class="number">1</span>) &#123;</span><br><span class="line">   <span class="comment">//如果在查询参数中使用了&#123;&#125;，则抛出异常。</span></span><br><span class="line">    String queryParams = value.substring(question + <span class="number">1</span>);</span><br><span class="line">    Matcher queryParamMatcher = PARAM_URL_REGEX.matcher(queryParams);</span><br><span class="line">    <span class="keyword">if</span> (queryParamMatcher.find()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(<span class="string">"URL query string \"%s\" must not have replace block. "</span></span><br><span class="line">          + <span class="string">"For dynamic query parameters use @Query."</span>, queryParams);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//赋值相对链接</span></span><br><span class="line">  <span class="keyword">this</span>.relativeUrl = value;</span><br><span class="line">  <span class="comment">//解析&#123;&#125;路径参数保存到Set中</span></span><br><span class="line">  <span class="keyword">this</span>.relativeUrlParamNames = parsePathParameters(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从源码可以发现，不允许在查询参数中使用<code>{}</code>进行占位，否则就会抛出异常，然后将请求方法中的注解值赋值给relativeUrl，通过<code>parsePathParameters</code>将{}路径参数保存到Set中。<br>通过<code>parseHeaders</code>来解析头部注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Headers <span class="title">parseHeaders</span><span class="params">(String[] headers)</span> </span>&#123;</span><br><span class="line">  Headers.Builder builder = <span class="keyword">new</span> Headers.Builder();</span><br><span class="line">  <span class="keyword">for</span> (String header : headers) &#123;</span><br><span class="line">    <span class="keyword">int</span> colon = header.indexOf(<span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">if</span> (colon == -<span class="number">1</span> || colon == <span class="number">0</span> || colon == header.length() - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> methodError(</span><br><span class="line">          <span class="string">"@Headers value must be in the form \"Name: Value\". Found: \"%s\""</span>, header);</span><br><span class="line">    &#125;</span><br><span class="line">    String headerName = header.substring(<span class="number">0</span>, colon);</span><br><span class="line">    String headerValue = header.substring(colon + <span class="number">1</span>).trim();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"Content-Type"</span>.equalsIgnoreCase(headerName)) &#123;</span><br><span class="line">      MediaType type = MediaType.parse(headerValue);</span><br><span class="line">      <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Malformed content type: %s"</span>, headerValue);</span><br><span class="line">      &#125;</span><br><span class="line">      contentType = type;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder.add(headerName, headerValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看完解析方法注解后，现在来看下是如何解析参数相关注解的。源码在<code>parseParameter</code>中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ParameterHandler&lt;?&gt; parseParameter(</span><br><span class="line">    <span class="keyword">int</span> p, Type parameterType, Annotation[] annotations) &#123;</span><br><span class="line">  ParameterHandler&lt;?&gt; result = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (Annotation annotation : annotations) &#123;<span class="comment">//遍历参数注解</span></span><br><span class="line">    ParameterHandler&lt;?&gt; annotationAction = parseParameterAnnotation(</span><br><span class="line">        p, parameterType, annotations, annotation);<span class="comment">//解析参数注解</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (annotationAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//一个参数中只允许使用一个注解，否则抛出异常</span></span><br><span class="line">      <span class="keyword">throw</span> parameterError(p, <span class="string">"Multiple Retrofit annotations found, only one allowed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = annotationAction;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，内部调用了<code>parseParameterAnnotation</code>来解析参数注解，此外，还进行了相关判断，虽然参数中可以使用多个注解，但Retrofit强制用户只能使用一个，否则抛出异常。<br><code>parseParameterAnnotation</code>中的源码实在太长了，这里就简单介绍下工作流程。首先根据注解来判断来校验使用上有没有错误，比如@Query注解必须在@Path和@Url后使用，使用了@Url注解那么请求方法注解中不允许设置请求路径等等；然后获取相应Converter用于转换类型(String,ResponseBody),最后初始化相应<code>ParameterHandler</code>返回。<br><code>ParameterHandler</code>这个抽象类用于处理参数，还内置了不同类型的参数转换类，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestBuilder builder, T value)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Body注解类型的转换</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Body</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ParameterHandler</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Converter&lt;T, RequestBody&gt; converter;</span><br><span class="line"></span><br><span class="line">    Body(Converter&lt;T, RequestBody&gt; converter) &#123;</span><br><span class="line">      <span class="keyword">this</span>.converter = converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestBuilder builder, T value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Body parameter value must not be null."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      RequestBody body;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        body = converter.convert(value);<span class="comment">//转换为RequestBody</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to convert "</span> + value + <span class="string">" to RequestBody"</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">      builder.setBody(body);<span class="comment">//设置Body</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">  <span class="comment">//省略了其他注解类型转换代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="调用服务接口"><a href="#调用服务接口" class="headerlink" title="调用服务接口"></a>调用服务接口</h4><p>以上介绍了<code>retrofit.create(XX.class);</code>用于创建服务方法接口的过程。现在该进行相关调用了。我们知道，创建服务方法会返回一个<code>Call&lt;XX&gt;</code>对象,通过<code>Call&lt;XX&gt;</code>可以进行相关异步同步调用。<br>默认CallAdapter相关源码实现在OkHttpCall中，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</span><br><span class="line"></span><br><span class="line">  okhttp3.Call call;<span class="comment">//okhttp中的call对象</span></span><br><span class="line">  Throwable failure;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already executed."</span>);</span><br><span class="line">    executed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    call = rawCall;</span><br><span class="line">    failure = creationFailure;</span><br><span class="line">    <span class="keyword">if</span> (call == <span class="keyword">null</span> &amp;&amp; failure == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        call = rawCall = createRawCall();<span class="comment">//创建原始Call，即okhttp中的Call对象</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        failure = creationFailure = t;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</span><br><span class="line">    callback.onFailure(<span class="keyword">this</span>, failure);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (canceled) &#123;</span><br><span class="line">    call.cancel();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//通过enqueue进行异步调用</span></span><br><span class="line">  call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      Response&lt;T&gt; response;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        response = parseResponse(rawResponse);<span class="comment">//解析响应内容</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        callFailure(e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      callSuccess(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从源码不难看出，首先通过<code>createRawCall()</code>来创建OkHttp中的Call对象，然后通过Call进行异步/同步调用,获取结果后通过<code>parseResponse</code>解析OkHttp中的Response，然后进行相应回调。<br><code>createRawCall()</code>用于创建OkHttp中的Call对象，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Request request = serviceMethod.toRequest(args);<span class="comment">//通过 serviceMethod.toRequest进行转换成Request</span></span><br><span class="line">  okhttp3.Call call = serviceMethod.callFactory.newCall(request);<span class="comment">//调用newCall返回Call对象，默认callFactory为OkHttpClient，OkHttpClient也实现了okhttp3.Call.Factory接口。</span></span><br><span class="line">  <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> call;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>parseResponse</code>用于解析原始Response，源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ResponseBody rawBody = rawResponse.body();<span class="comment">//获取ResponseBody</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//移除响应体</span></span><br><span class="line">  rawResponse = rawResponse.newBuilder()</span><br><span class="line">      .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> code = rawResponse.code();<span class="comment">//获取状态吗</span></span><br><span class="line">  <span class="comment">//code &lt; 200 || code &gt;= 300</span></span><br><span class="line">  <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//将整个rawBody缓冲到内存中回调</span></span><br><span class="line">      ResponseBody bufferedBody = Utils.buffer(rawBody);</span><br><span class="line">      <span class="keyword">return</span> Response.error(bufferedBody, rawResponse);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      rawBody.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//code == 204 || code == 205</span></span><br><span class="line">  <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</span><br><span class="line">    <span class="comment">//此时没有响应体，只需回调状态</span></span><br><span class="line">    <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    T body = serviceMethod.toResponse(catchingBody);<span class="comment">//通过`serviceMethod.toResponse`转换为对应对象</span></span><br><span class="line">    <span class="comment">//回调</span></span><br><span class="line">    <span class="keyword">return</span> Response.success(body, rawResponse);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    catchingBody.throwIfCaught();</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从<code>createRawCall()</code>和<code>parseResponse</code>的源码中，可以发现，通过 <code>serviceMethod.toRequest</code>进行转换成OkHttp中的Request，通过<code>serviceMethod.toResponse</code>将OkHttp中的Response转换为对应对象。<br>toRequest相关源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Request <span class="title">toRequest</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// RequestBuilder</span></span><br><span class="line">  RequestBuilder requestBuilder = <span class="keyword">new</span> RequestBuilder(httpMethod, baseUrl, relativeUrl, headers,</span><br><span class="line">      contentType, hasBody, isFormEncoded, isMultipart);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ParameterHandler数组</span></span><br><span class="line">  ParameterHandler&lt;Object&gt;[] handlers = (ParameterHandler&lt;Object&gt;[]) parameterHandlers;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; argumentCount; p++) &#123;</span><br><span class="line">    <span class="comment">//遍历数组进行循环应用</span></span><br><span class="line">    handlers[p].apply(requestBuilder, args[p]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> requestBuilder.build();<span class="comment">//通过build()返回Request对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>toResponse源码非常简单，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">T <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> responseConverter.convert(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，会调用<code>BuiltInConverters</code>中的转换器来转换，当然，更多时候我们回去应用Gson转换器来进行转换。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><ul>
<li><p>GsonConverterFactory是怎么工作的？<br>一般情况下，我们会加入<code>addConverterFactory(GsonConverterFactory.create())</code>来增加Gson转换功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonConverterFactory</span> <span class="keyword">extends</span> <span class="title">Converter</span>.<span class="title">Factory</span> </span>&#123;</span><br><span class="line"> <span class="comment">//默认Gson</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> create(<span class="keyword">new</span> Gson());</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//自己配置Gson</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">(Gson gson)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> GsonConverterFactory(gson);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="title">GsonConverterFactory</span><span class="params">(Gson gson)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (gson == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"gson == null"</span>);</span><br><span class="line">   <span class="keyword">this</span>.gson = gson;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//转换ResponseBody</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</span><br><span class="line">     Retrofit retrofit) &#123;</span><br><span class="line">   TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));<span class="comment">//根据Type获取TypeAdapter</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);<span class="comment">//转换逻辑代码</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转换成RequestBody</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</span><br><span class="line">     Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</span><br><span class="line">   TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));<span class="comment">//根据Type获取TypeAdapter</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> GsonRequestBodyConverter&lt;&gt;(gson, adapter);<span class="comment">//转换逻辑代码</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ResponseBody核心转换代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  JsonReader jsonReader = gson.newJsonReader(value.charStream());<span class="comment">//创建JsonReader</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> adapter.read(jsonReader);<span class="comment">//通过adapter转换</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    value.close();<span class="comment">//关闭流</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RequestBody核心转换代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> RequestBody <span class="title">convert</span><span class="params">(T value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">Buffer buffer = <span class="keyword">new</span> Buffer();</span><br><span class="line">Writer writer = <span class="keyword">new</span> OutputStreamWriter(buffer.outputStream(), UTF_8);</span><br><span class="line">JsonWriter jsonWriter = gson.newJsonWriter(writer);<span class="comment">//获取JsonWriter</span></span><br><span class="line">adapter.write(jsonWriter, value);<span class="comment">//adapter将value转换为Gson</span></span><br><span class="line">jsonWriter.close();</span><br><span class="line"><span class="keyword">return</span> Re</span><br></pre></td></tr></table></figure>
</li>
<li><p>RxJavaCallAdapterFactory是怎么工作的？<br>我们还可以加入<code>addCallAdapterFactory(RxJavaCallAdapterFactory.create())</code>使你的代码可以进行响应式编程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接创建    </span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJavaCallAdapterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> RxJavaCallAdapterFactory(<span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//指定工作线程创建</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJavaCallAdapterFactory <span class="title">createWithScheduler</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"scheduler == null"</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> RxJavaCallAdapterFactory(scheduler);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> CallAdapter&lt;?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</span><br><span class="line">   <span class="comment">//..</span></span><br><span class="line">   <span class="comment">//省略了部分源码，</span></span><br><span class="line">   <span class="comment">//通过getCallAdapter来获取Adapter</span></span><br><span class="line">    CallAdapter&lt;Observable&lt;?&gt;&gt; callAdapter = getCallAdapter(returnType, scheduler);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> callAdapter;</span><br><span class="line"> &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//获取CallAdapter&lt;Observable&lt;?&gt;&gt;</span></span><br><span class="line"> <span class="keyword">private</span> CallAdapter&lt;Observable&lt;?&gt;&gt; getCallAdapter(Type returnType, Scheduler scheduler) &#123;</span><br><span class="line">   Type observableType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) returnType);</span><br><span class="line">    Class&lt;?&gt; rawObservableType = getRawType(observableType);</span><br><span class="line">     <span class="comment">//..</span></span><br><span class="line">    <span class="comment">//省略了部分源码，</span></span><br><span class="line">    <span class="comment">//一般会走SimpleCallAdapter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleCallAdapter(observableType, scheduler);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//SimpleCallAdapter的源码如下</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCallAdapter</span> <span class="keyword">implements</span> <span class="title">CallAdapter</span>&lt;<span class="title">Observable</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Type responseType;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">   SimpleCallAdapter(Type responseType, Scheduler scheduler) &#123;</span><br><span class="line">     <span class="keyword">this</span>.responseType = responseType;</span><br><span class="line">     <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> responseType;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span> <span class="keyword">public</span> &lt;R&gt; <span class="function">Observable&lt;R&gt; <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//通过Observable.create创建被观察者</span></span><br><span class="line">     Observable&lt;R&gt; observable = Observable.create(<span class="keyword">new</span> CallOnSubscribe&lt;&gt;(call)) </span><br><span class="line">         .lift(OperatorMapResponseToBodyOrError.&lt;R&gt;instance());</span><br><span class="line">     <span class="keyword">if</span> (scheduler != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> observable.subscribeOn(scheduler);<span class="comment">//切换到指定线程</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> observable;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>CallOnSubscribe中使用了RequestArbiter中包装了<code>Call&lt;T&gt;</code>对象,然后通过call.execute()同步执行，最后将结果<code>subscriber.onNext(response)</code>回调出去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestArbiter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AtomicBoolean</span> <span class="keyword">implements</span> <span class="title">Subscription</span>, <span class="title">Producer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;T&gt; call;<span class="comment">//原始的Call</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; subscriber;</span><br><span class="line"></span><br><span class="line">  RequestArbiter(Call&lt;T&gt; call, Subscriber&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; subscriber) &#123;</span><br><span class="line">    <span class="keyword">this</span>.call = call;</span><br><span class="line">    <span class="keyword">this</span>.subscriber = subscriber;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Response&lt;T&gt; response = call.execute();<span class="comment">//call.execute()同步执行</span></span><br><span class="line">      <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">        subscriber.onNext(response);<span class="comment">//onNext回调</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      Exceptions.throwIfFatal(t);</span><br><span class="line">      <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">        subscriber.onError(t);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">      subscriber.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    call.cancel();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUnsubscribed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> call.isCanceled();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<p>本篇解读到此结束。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/22/HttpURLConnection-源码解读/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          HttpURLConnection 源码解读
        
      </div>
    </a>
  
  
    <a href="/2016/07/04/Python3-学习手册（三）-数据结构/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Python3 学习手册（三） 数据结构</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Retrofit2-源码解读" data-title="Retrofit2 源码解读" data-url="http://www.maplejaw.com/2016/07/22/Retrofit2-源码解读/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"maplejaw"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 maplejaw
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>